{"version":3,"sources":["associations.es6"],"names":["async","ParserUtils","DataAssociationMapping","_","DataQueryable","Args","QueryExpression","QueryFieldUtils","AbstractMethodError","AbstractClassError","DataError","DataNotFoundError","parentProperty","Symbol","modelProperty","baseModelProperty","mappingProperty","queryProperty","HasAssociation","obj","associationMapping","check","new","target","notNull","isString","isObject","getParent","model","getModel","inferMapping","assign","DataObjectAssociationListener","e","callback","isNil","keys","Object","mappings","forEach","x","hasOwnProperty","mapping","associationType","childModel","name","push","eachSeries","cb","field","childField","property","parentField","parseBoolean","cloned","associatedModel","context","parentModel","er","find","select","silent","flatten","take","list","err","result","Error","code","total","records","event","convert","childs","junction","isArray","HasManyToManyAssociation","$silent","getBaseModel","state","toBeRemoved","toBeInserted","$state","insert","remove","tags","HasTagAssociation","all","then","filter","indexOf","length","catch","HasOneToManyAssociation","getMapping","getContext","parent","create","getViewAdapter","where","equal","prepare","HasManyToOneAssociation","association","executeFunc","execute","self","migrate","bind","baseModel","Q","require","deferred","defer","insert_","reject","resolve","promise","call","remove_","parentObjectModel","parentObject","baseModelAdapter","modelAdapter","left","right","from","getName","join","with","conf","getConfiguration","baseModelDefinition","getModelDefinition","associationAdapter","adapter","setModelDefinition","title","sealed","hidden","type","source","view","version","fields","primary","indexed","nullable","constraints","insertSingleObject_","value","parentId","valueId","newItem","arr","otherModel","item","removeSingleObject_","HasTagAssociation_Insert_","removeAll","HasTagAssociation_Clear_","HasTagAssociation_Remove_","refersToType","getAttribute","refersTo","parentFieldType","definition","asArray","parentAdapter","objectField","$name","items","map","save"],"mappings":"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","file":"associations.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport 'source-map-support/register';\nimport async from 'async';\nimport {ParserUtils, DataAssociationMapping} from './types';\nimport _ from 'lodash';\nimport {DataQueryable} from './queryable';\nimport {Args} from \"@themost/common/utils\";\nimport {QueryExpression, QueryFieldUtils} from \"@themost/query/query\";\nimport {AbstractMethodError,AbstractClassError, DataError, DataNotFoundError} from '@themost/common/errors';\n\nconst parentProperty = Symbol('parent');\nconst modelProperty = Symbol('model');\nconst baseModelProperty = Symbol('basemodel');\nconst mappingProperty = Symbol('model');\nconst queryProperty = Symbol('query');\n/**\n * @class\n * @abstract\n * @augments DataQueryable\n */\nexport class HasAssociation extends DataQueryable {\n    constructor(obj, associationMapping) {\n        super();\n        Args.check(new.target !== HasAssociation, new AbstractClassError());\n        //validate parent object\n        Args.notNull(obj,'Parent object');\n        //set parent\n        this[parentProperty] = obj;\n\n        if (_.isString(associationMapping)) {\n            //query mapping based on the given name\n            if (_.isObject(this.getParent())) {\n                const model = this.getParent().getModel();\n                if (_.isObject(model))\n                    this[mappingProperty] = model.inferMapping(associationMapping);\n            }\n        }\n        else if (_.isObject(associationMapping)) {\n            //get the specified mapping\n            if (associationMapping instanceof DataAssociationMapping)\n                this[mappingProperty] = associationMapping;\n            else\n                this[mappingProperty] = _.assign(new DataAssociationMapping(), associationMapping);\n        }\n    }\n\n    /**\n     * Gets the source object of this association.\n     * @returns {DataObject|*}\n     */\n    getParent() {\n        return this[parentProperty];\n    }\n\n    /**\n     * Gets the definition of this association.\n     * @returns {DataAssociationMapping}\n     */\n    getMapping() {\n        return this[mappingProperty];\n    }\n\n    /**\n     * @abstract\n     */\n    get query() {\n        throw new AbstractMethodError();\n    }\n\n    /**\n     * @abstract\n     */\n    get model() {\n        throw new AbstractMethodError();\n    }\n\n}\n\n/**\n * @class\n */\nexport class DataObjectAssociationListener {\n    /**\n     *\n     * @param {DataEventArgs} e\n     * @param {Function} callback\n     */\n    beforeSave(e, callback) {\n        try {\n            if (_.isNil(e.target)) {\n                return callback();\n            }\n            else {\n                const keys = Object.keys(e.target);\n                const mappings = [];\n                keys.forEach(function(x) {\n                    if (e.target.hasOwnProperty(x) && typeof e.target[x] === 'object' && e.target[x] !== null) {\n                        //try to find field mapping, if any\n                        const mapping = e.model.inferMapping(x);\n                        if (mapping && mapping.associationType==='association' && mapping.childModel===e.model.name)\n                            mappings.push(mapping);\n                    }\n                });\n                async.eachSeries(mappings,\n                    /**\n                     * @param {DataAssociationMapping} mapping\n                     * @param {Function} cb\n                     */\n                    function(mapping, cb) {\n                        if (mapping.associationType==='association' && mapping.childModel===e.model.name) {\n                            /**\n                           * @type {DataField|*}\n                           */\n                            const field = e.model.field(mapping.childField);\n                            const childField = field.property || field.name;\n                            //foreign key association\n                            if (typeof e.target[childField] !== 'object') {\n                                return cb();\n                            }\n                            if (e.target[childField].hasOwnProperty(mapping.parentField)) {\n                                return cb();\n                            }\n                            //change:21-Mar 2016\n                            //description: check if association belongs to this model or it's inherited from any base model\n                            //if current association belongs to base model\n                            if ((e.model.name !== field.model) && (!ParserUtils.parseBoolean(field.cloned))) {\n                                //do nothing and exit\n                                return cb();\n                            }\n\n                            //get associated mode\n                            const associatedModel = e.model.context.model(mapping.parentModel);\n\n                            let er;\n                            associatedModel.find(e.target[childField]).select(mapping.parentField).silent().flatten().take(1).list(function(err, result) {\n                                if (err) {\n                                    cb(err);\n                                }\n                                else if (_.isNil(result)) {\n                                    er = new Error('An associated object cannot be found.');er.code = 'EDATA';er.model = associatedModel.name;\n                                    cb(er);\n                                }\n                                else if (result.total===0) {\n                                    er = new Error('An associated object cannot be found.');er.code = 'EDATA';er.model = associatedModel.name;\n                                    cb(er);\n                                }\n                                else if (result.total>1) {\n                                    er = new Error('An associated object is defined more than once and cannot be bound.'); er.code = 'EDATA';er.model = associatedModel.name;\n                                    cb(er);\n                                }\n                                else {\n                                    e.target[childField][mapping.parentField]=result.records[0][mapping.parentField];\n                                    cb();\n                                }\n                            });\n                        }\n                        else {\n                            cb();\n                        }\n\n                    }, function(err) {\n                        callback(err);\n                    });\n            }\n        }\n        catch (e) {\n            callback(e);\n        }\n\n    }\n\n    /**\n     *\n     * @param {DataEventArgs} event\n     * @param {Function} callback\n     */\n    afterSave(event, callback) {\n        try {\n            if (typeof event.target === 'undefined' || event.target === null) {\n                callback(null);\n            }\n            else {\n                const keys = Object.keys(event.target);\n                const mappings = [];\n                keys.forEach(function(x) {\n                    if (event.target.hasOwnProperty(x)) {\n                        /**\n                         * @type DataAssociationMapping\n                         */\n                        const mapping = event.model.inferMapping(x);\n                        if (mapping)\n                            if (mapping.associationType==='junction') {\n                                mappings.push({ name:x, mapping:mapping });\n                            }\n                    }\n                });\n                async.eachSeries(mappings,\n                    /**\n                     * @param {{name:string,mapping:DataAssociationMapping}} x\n                     * @param {Function} cb\n                     */\n                    function(x, cb) {\n                        if (x.mapping.associationType==='junction') {\n                            const obj = event.model.convert(event.target);\n\n                            /**\n                             * @type {*}\n                             */\n                            const childs = obj[x.name];\n\n                            let junction;\n                            if (!_.isArray(childs)) { return cb(); }\n                            if (x.mapping.childModel===event.model.name) {\n                                junction = new HasManyToManyAssociation(obj, x.mapping);\n                                if (event.model.$silent) {\n                                    junction.getBaseModel().silent();\n                                }\n                                if (event.state===1 || event.state===2) {\n                                    const toBeRemoved = [], toBeInserted = [];\n                                    _.forEach(childs, function(x) {\n                                        if (x.$state === 4) {\n                                            toBeRemoved.push(x);\n                                        }\n                                        else {\n                                            toBeInserted.push(x);\n                                        }\n                                    });\n                                    junction.insert(toBeInserted, function(err) {\n                                        if (err) { return cb(err); }\n                                        junction.remove(toBeRemoved, function(err) {\n                                            if (err) { return cb(err); }\n                                            return cb();\n                                        });\n                                    });\n                                }\n                                else  {\n                                    return cb();\n                                }\n                            }\n                            else if (x.mapping.parentModel===event.model.name) {\n\n                                if (event.state===1 || event.state===2) {\n                                    if (typeof x.mapping.childModel === 'undefined') {\n                                        /**\n                                         * @type {HasTagAssociation}\n                                         */\n                                        const tags = new HasTagAssociation(obj, x.mapping);\n                                        if (event.model.$silent) { tags.getBaseModel().silent(); }\n                                        return tags.silent().all().then(function(result) {\n\n                                            const toBeRemoved = _.filter(result,function(x) {\n                                                return childs.indexOf(x)<0;\n                                            });\n                                            const toBeInserted = _.filter(childs, function(x) {\n                                                return result.indexOf(x)<0;\n                                            });\n                                            if (toBeRemoved.length>0) {\n                                                return tags.remove(toBeRemoved).then(function() {\n                                                    if (toBeInserted.length===0) { return cb(); }\n                                                    return tags.insert(toBeInserted).then(function() {\n                                                        return cb();\n                                                    });\n                                                }).catch(function (err) {\n                                                    return cb(err);\n                                                });\n                                            }\n                                            if (toBeInserted.length===0) { return cb(); }\n                                            return tags.insert(toBeInserted).then(function() {\n                                                return cb();\n                                            });\n                                        }).catch(function (err) {\n                                            return cb(err);\n                                        });\n                                    }\n                                    else {\n                                        junction = new HasManyToManyAssociation(obj, x.mapping);\n                                        if (event.model.$silent) { junction.getBaseModel().silent(); }\n                                        junction.insert(childs, function(err) {\n                                            if (err) { return cb(err); }\n                                            const toBeRemoved = [], toBeInserted = [];\n                                            _.forEach(childs, function(x) {\n                                                if (x.$state === 4) {\n                                                    toBeRemoved.push(x);\n                                                }\n                                                else {\n                                                    toBeInserted.push(x);\n                                                }\n                                            });\n                                            junction.insert(toBeInserted, function(err) {\n                                                if (err) { return cb(err); }\n                                                junction.remove(toBeRemoved, function(err) {\n                                                    if (err) { return cb(err); }\n                                                    return cb();\n                                                });\n                                            });\n                                        });\n                                    }\n                                }\n                                else  {\n                                    cb();\n                                }\n                            }\n                            else {\n                                cb();\n                            }\n                        }\n                        else\n                            cb(null);\n\n                    }, function(err) {\n                        callback(err);\n                    });\n            }\n        }\n        catch (err) {\n            callback(err);\n        }\n    }\n}\n\n/**\n * @classdesc Represents a one-to-many association between two models.\n <p>\n This association may be defined in a field of a data model as follows:\n </p>\n <pre class=\"prettyprint\"><code>\n {\n    \"name\": \"Order\", \"id\": 449, \"title\": \"Order\", \"hidden\": false, \"sealed\": false,\n    \"abstract\": false, \"version\": \"1.0\",\n    \"fields\": [\n        ...\n        {\n            \"name\": \"customer\",\n            \"title\": \"Customer\",\n            \"description\": \"Party placing the order.\",\n            \"type\": \"Party\"\n        }\n        ...\n    ]\n }\n </code></pre>\n <p>\n where model Party has a one-to-many association with model Order.\n This association may also be defined in parent data model (Party) as follows:\n </p>\n <pre class=\"prettyprint\"><code>\n {\n    \"name\": \"Party\", ...,\n    \"fields\": [\n        ...\n        {\n            \"name\": \"orders\",\n            \"title\": \"Orders\",\n            \"description\": \"A collection of orders made by the party (Persor or Organization).\",\n            \"type\": \"Order\",\n            \"many\":true\n        }\n        ...\n    ]\n }\n </code></pre>\n <p>\n where property orders of Party model defines an one-to-many association between Party and Order.\n HasOneToManyAssociation class inherits DataQueryable class for filtering, paging, grouping or orderind child items.\n </p>\n <pre class=\"prettyprint\"><code>\n var parties = context.model('Party');\n parties.where('id').equal(327).first().then(function(result) {\n        var party = parties.convert(result);\n        party.property('orders')\n            .select('id','orderedItem/name as productName','paymentDue')\n            .where('paymentMethod/alternateName').equal('DirectDebit')\n            .list().then(function(result) {\n               done();\n            }).catch(function(err) {\n               done(err);\n            });\n    }).catch(function(err) {\n        done(err);\n    });\n </code></pre>\n <pre class=\"prettyprint\"><code>\n //Results:\n id  productName           paymentDue\n --  --------------------  -----------------------------\n 6   Alienware X51 (2013)  2015-10-06 18:08:10.000+03:00\n 7   LaCie Blade Runner    2015-06-16 22:38:52.000+03:00\n </code></pre>\n * @class\n * @augments DataQueryable\n * @property {DataAssociationMapping} mapping - Gets or sets the mapping definition of this data object association.\n */\nexport class HasOneToManyAssociation extends HasAssociation {\n    /**\n     * @constructor\n     * @param {DataObject} obj - An instance of DataObject class which represents the parent data object\n     * @param {string|*} associationMapping - A string that represents the name of the field which holds association mapping or the association mapping itself.\n     */\n    constructor(obj, associationMapping) {\n        super(obj, associationMapping);\n    }\n\n    /**\n     * @returns {DataModel}\n     */\n    get model() {\n        if (_.isNil(this[modelProperty])) {\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping),new DataError('Data association mapping cannot be empty at this context.'));\n            this[modelProperty] = this.getParent().getContext().model(mapping.childModel);\n        }\n        return this[modelProperty];\n    }\n\n    /**\n     * @returns {QueryExpression}\n     */\n    get query() {\n        if (_.isNil(this[queryProperty])) {\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping),new DataError('Data association cannot be empty at this context.'));\n            //prepare query by selecting the foreign key of the related object\n            const parent = this.getParent();\n            Args.check(_.isObject(parent),new DataError('Parent object cannot be empty at this context.'));\n            this[queryProperty] = QueryExpression.create(this.model.getViewAdapter())\n                .where(mapping.childField)\n                .equal(parent[mapping.parentField]).prepare();\n        }\n        return this[queryProperty];\n    }\n\n}\n\n\n/**\n * @classdesc Represents a foreign key association between two models.\n <p>\n This association may be defined in a field of a data model as follows:\n </p>\n <pre class=\"prettyprint\"><code>\n {\n    \"name\": \"Order\", \"id\": 449, \"title\": \"Order\", \"hidden\": false, \"sealed\": false,\n    \"abstract\": false, \"version\": \"1.0\",\n    \"fields\": [\n        ...\n        {\n            \"name\": \"customer\",\n            \"title\": \"Customer\",\n            \"description\": \"Party placing the order.\",\n            \"type\": \"Party\"\n        }\n        ...\n    ]\n }\n </code></pre>\n <p>\n where model Order has a foreign key association with model Party (Person or Organization).\n HasManyToOneAssociation class inherits DataQueryable class for selecting the associated item.\n </p>\n <pre class=\"prettyprint\"><code>\n var orders = context.model('Order');\n orders.where('id').equal(145).first().then(function(result) {\n        var order = orders.convert(result);\n        order.property('customer')\n            .first().then(function(result) {\n                done(null, result);\n            }).catch(function(err) {\n                done(err);\n            });\n    }).catch(function(err) {\n        done(err);\n    });\n </code></pre>\n * @class\n * @augments DataQueryable\n */\nexport class HasManyToOneAssociation extends HasAssociation {\n    /**\n     * @constructor\n     * @param {DataObject} obj - An instance of DataObject class that represents the parent data object\n     * @param {string|*} associationMapping A string that represents the name of the field which holds association mapping or the association mapping itself.\n     */\n    constructor(obj, associationMapping) {\n        super(obj, associationMapping);\n    }\n\n    /**\n     * @returns {QueryExpression}\n     */\n    get query() {\n        if (_.isNil(this[queryProperty])) {\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping), new DataError('Data association cannot be empty at this context.'));\n            //prepare query by selecting the foreign key of the related object\n            const parent = this.getParent();\n            Args.check(_.isObject(parent),new DataError('Parent object cannot be empty at this context.'));\n            this[queryProperty] = QueryExpression.create(this.model.getViewAdapter())\n                .where(mapping.parentField)\n                .equal(parent[mapping.childField]).prepare();\n        }\n        return this[queryProperty];\n    }\n\n    /**\n     * @returns {DataModel}\n     */\n    get model() {\n        if (_.isNil(this[modelProperty])) {\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping),new DataError('Data association mapping cannot be empty at this context.'));\n            this[modelProperty] = this.getParent().getContext().model(mapping.parentModel);\n        }\n        return this[modelProperty];\n    }\n}\n\n\n\n\n/**\n * @classdesc Represents a many-to-many association between two data models.\n * <p>\n *     This association may be defined in a field of a child model as follows:\n * </p>\n * <pre class=\"prettyprint\"><code>\n {\n     \"name\": \"User\", \"id\": 90, \"title\": \"Users\", \"inherits\": \"Account\", \"hidden\": false, \"sealed\": false, \"abstract\": false, \"version\": \"1.4\",\n     \"fields\": [\n        ...\n        {\n\t\t\t\"name\": \"groups\", \"title\": \"User Groups\", \"description\": \"A collection of groups where user belongs.\",\n\t\t\t\"type\": \"Group\",\n\t\t\t\"expandable\": true,\n\t\t\t\"mapping\": {\n\t\t\t\t\"associationAdapter\": \"GroupMembers\", \"parentModel\": \"Group\",\n\t\t\t\t\"parentField\": \"id\", \"childModel\": \"User\", \"childField\": \"id\",\n\t\t\t\t\"associationType\": \"junction\", \"cascade\": \"delete\",\n\t\t\t\t\"select\": [\n\t\t\t\t\t\"id\",\n\t\t\t\t\t\"name\",\n\t\t\t\t\t\"alternateName\"\n\t\t\t\t]\n\t\t\t}\n\t\t}\n        ...\n     ]\n     }\n </code></pre>\n <p>\n where model [User] has a many-to-many association with model [Group] in order to define the groups where a user belongs.\n This association will produce a database table with name of the specified association adapter name. If this name is missing\n then it will produce a table with a default name which comes of the concatenation of the model and the associated model.\n </p>\n <p>\n An instance of HasParentJunction class overrides DataQueryable methods for filtering associated objects:\n </p>\n <pre class=\"prettyprint\"><code>\n //check if the selected user belongs to Administrators group by querying user groups\n var users = context.model('User');\n users.where('name').equal('alexis.rees@example.com')\n .first().then(function(result) {\n        var user = users.convert(result);\n        user.property('groups').where('name').equal('Users').count().then(function(result) {\n            done(null, result);\n        });\n    }).catch(function(err) {\n        done(err);\n    });\n </code></pre>\n <p>\n Connects two objects (by inserting an association between parent and child object):\n </p>\n <pre class=\"prettyprint\"><code>\n //add the selected user to Administrators\n var users = context.model('User');\n users.where('name').equal('alexis.rees@example.com')\n .first().then(function(result) {\n        var user = users.convert(result);\n        user.property('groups').insert({ name:\"Administrators\" }).then(function(result) {\n            done(null, result);\n        });\n    }).catch(function(err) {\n        done(err);\n    });\n </code></pre>\n <p>\n Disconnects two objects (by removing an existing association):\n </p>\n <pre class=\"prettyprint\"><code>\n //remove the selected user from Administrators group\n var users = context.model('User');\n users.where('name').equal('alexis.rees@example.com')\n .first().then(function(result) {\n        var user = users.convert(result);\n        user.property('groups').remove({ name:\"Administrators\" }).then(function(result) {\n            done(null, result);\n        });\n    }).catch(function(err) {\n        done(err);\n    });\n </code></pre>\n * @class\n * @constructor\n * @augments DataQueryable\n * @param {DataObject} obj The parent data object reference\n * @param {string|*} association - A string that represents the name of the field which holds association mapping or the association mapping itself.\n * @property {DataModel} baseModel - The model associated with this data object junction\n * @property {DataObject} parent - Gets or sets the parent data object associated with this instance of DataObjectJunction class.\n * @property {DataAssociationMapping} mapping - Gets or sets the mapping definition of this data object association.\n */\nexport class HasManyToManyAssociation extends HasAssociation {\n    constructor(obj, association) {\n        super(obj, association);\n    }\n\n    /**\n     * @returns {DataModel}\n     */\n    get model() {\n        if (_.isNil(this[modelProperty])) {\n            const mapping = this.getMapping(),\n                parentObjectModel = this.getParent().getModel();\n            if (mapping.parentModel === parentObjectModel.name) {\n                this[modelProperty] = this.getParent().getContext().model(mapping.childModel);\n            }\n            else if(mapping.childModel === parentObjectModel.name) {\n                this[modelProperty] = this.getParent().getContext().model(mapping.parentModel);\n            }\n            else {\n                //throw association error\n                throw new DataError('Data association model cannot be found or is mispelled');\n            }\n        }\n        return this[modelProperty];\n    }\n\n    get query() {\n        if (_.isNil(this[queryProperty])) {\n            const mapping = this.getMapping(),\n                parentObject = this.getParent(),\n                parentObjectModel = parentObject.getModel();\n            Args.check(_.isObject(mapping), new DataError('Data association mapping cannot be empty at this context'));\n            //initialize query\n            this[queryProperty] = QueryExpression.create(this.model.getViewAdapter());\n            //get association adapter\n            const baseModelAdapter = this.baseModel.getViewAdapter();\n            //get model adapter\n            const modelAdapter = this.model.getViewAdapter();\n            const left = {}, right={};\n            const parentField = QueryFieldUtils.select('parentId').from(baseModelAdapter).getName(),\n                childField = QueryFieldUtils.select('valueId').from(baseModelAdapter).getName();\n            //find parent field\n            if (mapping.parentModel === parentObjectModel.name) {\n                left[modelAdapter] = [ mapping.childField ];\n                right[baseModelAdapter] = [childField];\n                this[queryProperty].join(baseModelAdapter, [])\n                    .with([left, right])\n                    .where(parentField).equal(parentObject[mapping.parentField]).prepare();\n                return this[queryProperty];\n            }\n            else if (mapping.childModel === parentObjectModel.name) {\n                left[modelAdapter] = [ mapping.parentField ];\n                right[baseModelAdapter] = [parentField];\n                this[queryProperty].join(baseModelAdapter, [])\n                    .with([left, right])\n                    .where(childField).equal(parentObject[mapping.childField]).prepare();\n                return this[queryProperty];\n            }\n            //throw association error\n            throw new DataError('Data association model cannot be found or is mispelled');\n        }\n        return this[queryProperty];\n    }\n\n    /**\n     * Overrides DataQueryable.execute() method\n     * @param callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @ignore\n     */\n    execute(callback) {\n        const executeFunc = super.prototype.execute;\n        const self = this;\n        self.migrate(function(err) {\n            if (err) { return callback(err); }\n            executeFunc.bind(self)(callback);\n        });\n    }\n\n    /**\n     * Gets an instance of DataModel which represents the data model where this association stores data.\n     * @returns {DataModel}\n     */\n    get baseModel() {\n        if (_.isNil(this[baseModelProperty])) {\n            const conf = this.getParent().getContext().getConfiguration();\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping), new DataError('Data association mapping cannot be empty at this context'));\n            //search in cache (configuration.current.cache)\n            const baseModelDefinition = conf.getModelDefinition(mapping.associationAdapter);\n            if (_.isObject(baseModelDefinition)) {\n                this[baseModelProperty] = this.getParent().getContext().model(this.getMapping().associationAdapter);\n                return this[baseModelProperty];\n            }\n            //otherwise create model\n            const parentModel = this.getParent().getModel();\n            const parentField = parentModel.field(mapping.parentField);\n            const childModel = this.getParent().getContext().model(mapping.childModel);\n            const childField = childModel.field(mapping.childField);\n            const adapter = mapping.associationAdapter;\n            //set model definition\n            conf.setModelDefinition({\n                name: adapter, title: adapter, sealed: false, hidden: true, type: \"hidden\",\n                source: adapter, view: adapter, version: '1.0',\n                fields: [\n                    {name: \"id\", type: \"Counter\", primary: true},\n                    {\n                        name: 'parentId',\n                        indexed: true,\n                        nullable: false,\n                        type: (parentField.type === 'Counter') ? 'Integer' : parentField.type\n                    },\n                    {\n                        name: 'valueId',\n                        indexed: true,\n                        nullable: false,\n                        type: (childField.type === 'Counter') ? 'Integer' : childField.type\n                    }],\n                constraints: [\n                    {\n                        type: \"unique\",\n                        fields: ['parentId', 'valueId']\n                    }\n                ],\n                \"privileges\": [\n                    {\"mask\": 15, \"type\": \"global\"}\n                ]\n            });\n            this[baseModelProperty] = this.getParent().getContext().model(mapping.associationAdapter);\n        }\n        return this[baseModelProperty];\n    }\n\n    getBaseModel() {\n        return this.baseModel;\n    }\n\n    /**\n     * Inserts an association between parent object and the given object or array of objects.\n     * @param {*|Array} obj - An object or an array of objects to be related with parent object\n     * @param {Function=} callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @returns {Promise<T>|*} - If callback parameter is missing then returns a Promise object.\n     * @example\n     //add the selected user to Administrators\n     var users = context.model('User');\n     users.where('name').equal('alexis.rees@example.com')\n     .first().then(function(result) {\n            var user = users.convert(result);\n            user.property('groups').insert({ name:\"Administrators\" }).then(function(result) {\n                done(null, result);\n            });\n        }).catch(function(err) {\n            done(err);\n        });\n     */\n    insert(obj, callback) {\n        const self = this;\n        if (typeof callback !== 'function') {\n            const Q = require('q'), deferred = Q.defer();\n            insert_.bind(self)(obj, function(err) {\n                if (err) { return deferred.reject(err); }\n                deferred.resolve(null);\n            });\n            return deferred.promise;\n        }\n        else {\n            return insert_.call(self, obj, callback);\n        }\n    }\n\n    /**\n     * Removes the association between parent object and the given object or array of objects.\n     * @param {*|Array} obj - An object or an array of objects to be disconnected from parent object\n     * @param {Function=} callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @returns {Promise<T>|*} - If callback parameter is missing then returns a Promise object.\n     * @example\n     //remove the selected user from Administrators group\n     var users = context.model('User');\n     users.where('name').equal('alexis.rees@example.com')\n     .first().then(function(result) {\n            var user = users.convert(result);\n            user.property('groups').remove({ name:\"Administrators\" }).then(function(result) {\n                done(null, result);\n            });\n        }).catch(function(err) {\n            done(err);\n        });\n     */\n    remove(obj, callback) {\n        const self = this;\n        if (typeof callback !== 'function') {\n            const Q = require('q'), deferred = Q.defer();\n            remove_.bind(self)(obj, function(err) {\n                if (err) { return deferred.reject(err); }\n                deferred.resolve(null);\n            });\n            return deferred.promise;\n        }\n        else {\n            return remove_.call(self, obj, callback);\n        }\n    }\n\n    migrate(callback) {\n        this.baseModel.migrate(callback);\n    }\n}\n\n\n/**\n * @function\n * @memberOf HasManyToManyAssociation\n * Inserts a new association between a parent and a child object.\n * @param {DataObject|*} obj An object or an identifier that represents the child object\n * @param {Function} callback\n * @private\n */\nfunction insertSingleObject_(obj, callback) {\n    /**\n     * @type {HasManyToManyAssociation|*}\n     */\n    const self = this;\n    const mapping = self.getMapping();\n    const parent = self.getParent();\n\n    if (self.model.name === mapping.parentModel) {\n        //get parent id\n        return parent.property(mapping.parentField).value().then(function(parentId) {\n            \n            if (_.isNil(parentId)) {\n                return callback(new DataNotFoundError('Parent object cannot be found.'))\n            }\n            //get child id\n            return obj.property(mapping.childField).value().then(function(valueId) {\n                if (_.isNil(parentId)) {\n                    return callback(new DataNotFoundError('Child object cannot be found.'))\n                }\n                const newItem = { };\n                newItem['parentId'] = parentId;\n                newItem['valueId'] = valueId;\n                self.baseModel.insert(newItem, callback);\n            });\n        });\n    }\n    else if (self.model.name === mapping.childModel) {\n        return obj.property(mapping.parentField).value().then(function(parentId) {\n            if (_.isNil(parentId)) {\n                return callback(new DataNotFoundError('Parent object cannot be found.'))\n            }\n            return parent.property(mapping.childField).value().then(function(valueId) {\n                if (_.isNil(parentId)) {\n                    return callback(new DataNotFoundError('Child object cannot be found.'))\n                }\n                const newItem = { };\n                newItem['parentId'] = parentId;\n                newItem['valueId'] = valueId;\n                self.baseModel.insert(newItem, callback);\n            });\n        });\n    }\n    else {\n        return callback(new DataError('Data association mapping cannot be resolved.'));\n    }\n}\n/**\n * @memberOf HasManyToManyAssociation\n * @param {*} obj\n * @param {Function} callback\n * @private\n */\nfunction insert_(obj, callback) {\n    /**\n     *\n     * @type {HasAssociation|*}\n     */\n    const self = this;\n    const mapping = self.getMapping();\n    let arr = [];\n    if (_.isArray(obj))\n        arr = obj;\n    else {\n        arr.push(obj);\n    }\n    self.migrate(function(err) {\n        if (err)\n            callback(err);\n        else {\n            //get other model\n            let otherModel;\n            if (self.model.name === mapping.parentModel) {\n                otherModel = self.getParent().getContext().model(mapping.childModel);\n            }\n            else if (self.model.name === mapping.childModel) {\n                otherModel = self.getParent().getContext().model(mapping.parentModel);\n            }\n            async.eachSeries(arr, function(item, cb) {\n                return insertSingleObject_.call(self,otherModel.convert(item), cb)\n            }, callback);\n        }\n    });\n}\n\n/**\n * @memberOf HasManyToManyAssociation\n * Removes a relation between a parent and a child object.\n * @param {*} obj An object or an identifier that represents the child object\n * @param {Function} callback\n * @private\n */\nfunction removeSingleObject_(obj, callback) {\n    /**\n     * @type {HasManyToManyAssociation|*}\n     */\n    const self = this;\n    const mapping = self.getMapping();\n    const parent = self.getParent();\n\n    if (self.model.name === mapping.parentModel) {\n        //get parent id\n        return parent.property(mapping.parentField).value().then(function(parentId) {\n            \n            if (_.isNil(parentId)) {\n                return callback(new DataNotFoundError('Parent object cannot be found.'))\n            }\n            //get child id\n            return obj.property(mapping.childField).value().then(function(valueId) {\n                if (_.isNil(parentId)) {\n                    return callback(new DataNotFoundError('Child object cannot be found.'))\n                }\n                const newItem = { };\n                newItem['parentId'] = parentId;\n                newItem['valueId'] = valueId;\n                self.baseModel.remove(newItem, callback);\n            });\n        });\n    }\n    else if (self.model.name === mapping.childModel) {\n        return obj.property(mapping.parentField).value().then(function(parentId) {\n            if (_.isNil(parentId)) {\n                return callback(new DataNotFoundError('Parent object cannot be found.'))\n            }\n            return parent.property(mapping.childField).value().then(function(valueId) {\n                \n                if (_.isNil(parentId)) {\n                    return callback(new DataNotFoundError('Child object cannot be found.'))\n                }\n                const newItem = { };\n                newItem['parentId'] = parentId;\n                newItem['valueId'] = valueId;\n                self.baseModel.remove(newItem, callback);\n            });\n        });\n    }\n    else {\n        return callback(new DataError('Data association mapping cannot be resolved.'));\n    }\n}\n/**\n * @memberOf HasManyToManyAssociation\n * @param {*} obj\n * @param {Function} callback\n * @private\n */\nfunction remove_(obj, callback) {\n    /**\n     *\n     * @type {HasAssociation|*}\n     */\n    const self = this;\n    const mapping = self.getMapping();\n    let arr = [];\n    if (_.isArray(obj))\n        arr = obj;\n    else {\n        arr.push(obj);\n    }\n    self.migrate(function(err) {\n        if (err)\n            callback(err);\n        else {\n            //get other model\n            let otherModel;\n            if (self.model.name === mapping.parentModel) {\n                otherModel = self.getParent().getContext().model(mapping.childModel);\n            }\n            else if (self.model.name === mapping.childModel) {\n                otherModel = self.getParent().getContext().model(mapping.parentModel);\n            }\n            async.eachSeries(arr, function(item, cb) {\n                return removeSingleObject_.call(self,otherModel.convert(item), cb)\n            }, callback);\n        }\n    });\n}\n\n/**\n * @classdesc Represents a collection of values associated with a data object e.g. a collection of tags of an article, a set of skills of a person etc.\n * <p>\n *     This association may be defined in a field of a data model as follows:\n * </p>\n * <pre class=\"prettyprint\"><code>\n {\n     \"name\": \"Person\", \"title\": \"Persons\", \"inherits\":\"Party\", \"version\": \"1.1\",\n     \"fields\": [\n        ...\n        {\n            \"@id\": \"https://themost.io/skills\",\n            \"name\": \"skills\",\n            \"title\": \"Skills\",\n            \"description\": \"A collection of skills of this person.\",\n            \"many\": true,\n            \"type\": \"Text\"\n        }\n        ...\n     ]\n     }\n </code></pre>\n <p>\n where model [Person] has a one-to-many association with a collection of strings in order to define the skills of a person.\n </p>\n <p>\n An instance of HasTagAssociation class overrides DataQueryable methods for filtering associated values:\n </p>\n <pre class=\"prettyprint\"><code>\n var persons = context.model('Person');\n persons.where('email').equal('veronica.fletcher@example.com')\n .getTypedItem().then(function(person) {\n            person.property('skills').all().then(function(result) {\n                return done(null, result);\n            });\n        }).catch(function(err) {\n            return done(err);\n        });\n </code></pre>\n <p>\n Insert item(s):\n </p>\n <pre class=\"prettyprint\"><code>\n var persons = context.model('Person');\n persons.where('email').equal('veronica.fletcher@example.com')\n .getTypedItem().then(function(person) {\n                person.property('skills').insert([\n                    \"node.js\",\n                    \"C#.NET\",\n                    \"PHP\"\n                ]).then(function() {\n                    return done();\n                });\n            }).catch(function(err) {\n                return done(err);\n            });\n </code></pre>\n <p>\n Remove item(s):\n </p>\n <pre class=\"prettyprint\"><code>\n var persons = context.model('Person');\n persons.where('email').equal('veronica.fletcher@example.com')\n .getTypedItem().then(function(person) {\n                person.property('skills').remove([\n                    \"C#.NET\"\n                ]).then(function() {\n                    return done();\n                });\n            }).catch(function(err) {\n                return done(err);\n            });\n </code></pre>\n * @class\n * @augments DataQueryable\n * @property {DataModel} baseModel - The model associated with this data object junction\n * @property {DataObject} parent - Gets or sets the parent data object associated with this instance of HasTagAssociation class.\n * @property {DataAssociationMapping} mapping - Gets or sets the mapping definition of this data object association.\n */\nexport class HasTagAssociation extends HasAssociation {\n    /**\n     * @constructor\n     * @param {DataObject} obj An object which represents the parent data object\n     * @param {String|*} association A string that represents the name of the field which holds association mapping or the association mapping itself.\n     */\n    constructor(obj, association) {\n        super(obj, association);\n    }\n    /**\n     * @returns {DataModel}\n     */\n    get model() {\n        return this.baseModel;\n    }\n\n    /**\n     * @returns {DataModel}\n     */\n    get baseModel() {\n\n        if (_.isNil(this[baseModelProperty])) {\n            const conf = this.getParent().getContext().getConfiguration();\n            const mapping = this.getMapping();\n            Args.check(_.isObject(mapping), new DataError('Data association mapping cannot be empty at this context'));\n            //search in cache (configuration.current.cache)\n            const baseModelDefinition = conf.getModelDefinition(mapping.associationAdapter);\n            if (_.isObject(baseModelDefinition)) {\n                this[baseModelProperty] = this.getParent().getContext().model(mapping.associationAdapter);\n                return this[baseModelProperty];\n            }\n            //otherwise create model\n            const parentModel = this.getParent().getModel();\n            const refersToType = parentModel.getAttribute(mapping.refersTo).type;\n            let parentFieldType = parentModel.getAttribute(mapping.parentField).type;\n            if (parentFieldType === 'Counter') { parentFieldType = 'Integer'; }\n            const definition = {\n                \"name\": mapping.associationAdapter,\n                \"hidden\": true,\n                \"source\": mapping.associationAdapter,\n                \"view\": mapping.associationAdapter,\n                \"version\": \"1.0\",\n                \"fields\": [\n                    {\n                        \"name\": \"id\", \"type\": \"Counter\", \"nullable\": false, \"primary\": true\n                    },\n                    {\n                        \"name\": \"object\", \"type\": parentFieldType, \"nullable\": false, \"many\": false\n                    },\n                    {\n                        \"name\": \"value\", \"type\": refersToType, \"nullable\": false\n                    }\n                ],\n                \"constraints\": [\n                    { \"type\":\"unique\", \"fields\": [ \"object\", \"value\" ] }\n                ],\n                \"privileges\": [\n                    {\n                        \"mask\": 15, \"type\": \"global\"\n                    }\n                ]\n            };\n            conf.setModelDefinition(definition);\n\n            this[baseModelProperty] = this.getParent().getContext().model(mapping.associationAdapter);\n        }\n        return this[baseModelProperty];\n    }\n\n    getBaseModel() {\n        return this.baseModel;\n    }\n\n    get query() {\n        if (_.isNil(this[queryProperty])) {\n            const mapping = this.getMapping(),\n                parentObject = this.getParent();\n            Args.check(_.isObject(mapping), new DataError('Data association mapping cannot be empty at this context'));\n            //get model adapter\n            const modelAdapter = this.model.getViewAdapter();\n            //initialize query\n            this[queryProperty] = QueryExpression.create(this.model.getViewAdapter());\n            //add select\n            this.select(\"value\").asArray();\n            //modify query (add join)\n            const left = {}, right = {};\n            //get parent object adapter\n            const parentAdapter = parentObject.getModel().getViewAdapter();\n            left[ parentAdapter ] = [ mapping.parentField ];\n            right[ modelAdapter ] = [ QueryFieldUtils.select(\"object\").from(modelAdapter).getName() ];\n            const objectField = QueryFieldUtils.select(\"object\").from(modelAdapter).$name;\n            this[queryProperty].join(parentAdapter, []).with([left, right]).where(objectField).equal(parentObject[mapping.parentField]).prepare(false);\n        }\n        return this[queryProperty];\n    }\n\n    /**\n     * Migrates the underlying data association adapter.\n     * @param callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     */\n    migrate(callback) {\n        this.baseModel.migrate(callback);\n    }\n\n    /**\n     * Overrides DataQueryable.execute() method\n     * @param callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @ignore\n     */\n    execute(callback) {\n        const executeFunc = super.prototype.execute;\n        const self = this;\n        self.migrate(function(err) {\n            if (err) { return callback(err); }\n            executeFunc.call(self, callback);\n        });\n    }\n\n    /**\n     * Inserts an array of values\n     * @param {*} obj\n     * @param {Function=} callback\n     * @example\n     context.model('Person').where('email').equal('veronica.fletcher@example.com')\n     .getTypedItem().then(function(person) {\n            person.property('skills').insert([\n                \"node.js\",\n                \"C#.NET\"\n            ]).then(function() {\n                return done();\n            });\n        }).catch(function(err) {\n            return done(err);\n        });\n     *\n     */\n    insert(obj, callback) {\n        const self = this;\n        if (typeof callback !== 'function') {\n            const Q = require('q'), deferred = Q.defer();\n            HasTagAssociation_Insert_.call(self, obj, function(err) {\n                if (err) { return deferred.reject(err); }\n                deferred.resolve(null);\n            });\n            return deferred.promise;\n        }\n        else {\n            return HasTagAssociation_Insert_.call(self, obj, callback);\n        }\n    }\n\n    /**\n     * Removes all values\n     * @param {Function=} callback\n     * @deprecated - This method is deprecated. Use removeAll() method instead\n     */\n    clear(callback) {\n        return this.removeAll(callback);\n    }\n\n    /**\n     * Removes all values\n     * @param {Function=} callback\n     * @example\n     context.model('Person').where('email').equal('veronica.fletcher@example.com')\n     .getTypedItem().then(function(person) {\n            person.property('skills').removeAll().then(function() {\n                return done();\n            });\n        }).catch(function(err) {\n            return done(err);\n        });\n     *\n     */\n    removeAll(callback) {\n        const self = this;\n        if (typeof callback !== 'function') {\n            const Q = require('q'), deferred = Q.defer();\n            HasTagAssociation_Clear_.bind(self)(function(err) {\n                if (err) { return deferred.reject(err); }\n                deferred.resolve();\n            });\n            return deferred.promise;\n        }\n        else {\n            return HasTagAssociation_Clear_.call(self, callback);\n        }\n    }\n\n    /**\n     * Removes a value or an array of values\n     * @param {Array|*} obj\n     * @param {Function=} callback\n     * @example\n     context.model('Person').where('email').equal('veronica.fletcher@example.com')\n     .getTypedItem().then(function(person) {\n            person.property('skills').remove([\n                \"node.js\"\n            ]).then(function() {\n                return done();\n            });\n        }).catch(function(err) {\n            return done(err);\n        });\n     *\n     */\n    remove(obj, callback) {\n        const self = this;\n        if (typeof callback !== 'function') {\n            const Q = require('q'), deferred = Q.defer();\n            HasTagAssociation_Remove_.call(self, obj, function(err) {\n                if (err) { return deferred.reject(err); }\n                deferred.resolve(null);\n            });\n            return deferred.promise;\n        }\n        else {\n            return HasTagAssociation_Remove_.call(self, obj, callback);\n        }\n    }\n}\n/**\n * @memberOf HasTagAssociation\n * @param {*} obj\n * @param {Function} callback\n * @private\n */\nfunction HasTagAssociation_Insert_(obj, callback) {\n    const self = this;\n    let arr = [];\n    if (_.isArray(obj))\n        arr = obj;\n    else {\n        arr.push(obj);\n    }\n    self.migrate(function(err) {\n        if (err)\n            return callback(err);\n\n        const items = arr.map(function (x) {\n            return {\n                \"object\": self.parent[self.mapping.parentField],\n                \"value\": x\n            }\n        });\n        if (self.$silent) { self.getBaseModel().silent(); }\n        return self.getBaseModel().save(items, callback);\n    });\n}\n/**\n * @memberOf HasTagAssociation\n * @param {Function} callback\n * @private\n */\nfunction HasTagAssociation_Clear_(callback) {\n    const self = this;\n    self.migrate(function(err) {\n        if (err) {\n            return callback(err);\n        }\n        if (self.$silent) { this.getBaseModel().silent(); }\n        self.getBaseModel().where(\"object\").equal(self.parent[self.mapping.parentField]).select(\"id\").all().then(function(result) {\n            if (result.length===0) { return callback(); }\n            return self.getBaseModel().remove(result).then(function () {\n                return callback();\n            });\n        }).catch(function(err) {\n            return callback(err);\n        });\n    });\n}\n/**\n * @memberOf HasTagAssociation\n * @param {*} obj\n * @param {Function} callback\n * @private\n */\nfunction HasTagAssociation_Remove_(obj, callback) {\n    const self = this;\n    let arr = [];\n    if (_.isArray(obj))\n        arr = obj;\n    else {\n        arr.push(obj);\n    }\n    self.migrate(function(err) {\n        if (err) {\n            return callback(err);\n        }\n        const items = arr.map(function (x) {\n            return {\n                \"object\": self.parent[self.mapping.parentField],\n                \"value\": x\n            }\n        });\n        if (self.$silent) { self.getBaseModel().silent(); }\n        return self.getBaseModel().remove(items, callback);\n    });\n}"]}