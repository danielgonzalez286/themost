{"version":3,"sources":["cache.es6"],"names":["SequentialEventEmitter","_","Rx","Args","rawCacheProperty","Symbol","DataCache","initialized","callback","cacheModule","NodeCache","require","err","key","self","Observable","bindNodeCallback","init","set","flushAll","value","absoluteExpiration","fn","check","isFunction","get","flatMap","res","isNil","source","of","add","result","cacheService","current","NoDataCache","window","global","application","getService","getCurrent"],"mappings":"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","file":"cache.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\n\nimport {SequentialEventEmitter} from '@themost/common/emitter';\nimport {_} from 'lodash';\nimport Rx from 'rxjs';\nimport {Args} from \"@themost/common/utils\";\n\nconst rawCacheProperty = Symbol('rawCache');\n\n/**\n * @class\n * @classdesc Implements data cache mechanisms in MOST Data Applications.\n * DataCache class is used as the internal data caching engine, if any other caching mechanism is not defined.\n * @property {Number} ttl - An amount of time in seconds which is the default cached item lifetime.\n * @constructor\n * @augments EventEmitter2\n */\nexport class DataCache extends SequentialEventEmitter {\n\n    constructor() {\n        super();\n        this.initialized = false;\n    }\n\n    /**\n     * Initializes data caching.\n     * @param {Function} callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @private\n     */\n    init(callback) {\n        try {\n            if (this.initialized) {\n                return callback();\n            }\n            const cacheModule = \"node-cache\";\n            const NodeCache = require(cacheModule);\n            this[rawCacheProperty] = new NodeCache();\n            this.initialized = true;\n            return callback();\n        }\n        catch (err) {\n            callback(err);\n        }\n    }\n\n    /**\n     * Removes a cached value.\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Observable}\n     */\n    remove(key) {\n        const self = this;\n        return Rx.Observable.bindNodeCallback((callback) => {\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].set(key, callback);\n            });\n        })();\n    }\n\n    /**\n     * Flush all cached data.\n     * @returns {Observable}\n     */\n    clear() {\n        const self = this;\n        return Rx.Observable.bindNodeCallback((callback) => {\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].flushAll();\n                return callback();\n            });\n        })();\n    }\n\n    /**\n     * Sets a key value pair in cache.\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    add(key, value, absoluteExpiration) {\n        const self = this;\n        return Rx.Observable.bindNodeCallback((callback) => {\n            self.init(function(err) {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].set(key, value, absoluteExpiration, callback);\n            });\n        })();\n    }\n\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        const self = this;\n        Args.check(_.isFunction(fn),'Invalid argument. Expected function.');\n        return self.get(key).flatMap((res) => {\n            if (_.isNil(res)) {\n                let source = fn();\n                Args.check(source instanceof Observable, 'Invalid argument. Expected a valid observable.');\n                return source.flatMap((res) => {\n                    if (_.isNil(res)) {\n                        return Rx.Observable.of();\n                    }\n                    return self.add(key,res,absoluteExpiration).flatMap(() => {\n                        return Rx.Observable.of(res);\n                    });\n                });\n            }\n            return Rx.Observable.of(res);\n        })();\n    }\n\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string|*} key\n     * @returns {Observable}\n     */\n    get(key) {\n        const self = this;\n        return Rx.Observable.bindNodeCallback((key,callback) => {\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                return self[rawCacheProperty].get(key, function(err, result) {\n                    if (err) {\n                        return callback(err);\n                    }\n                    if (typeof result[key] !== 'undefined') {\n                        return callback(null, result[key]);\n                    }\n                    return callback();\n                });\n            });\n        })(key);\n    }\n\n    /**\n     * Returns the current cache service.\n     * @returns {*|DataCache}\n     */\n    static getCurrent() {\n        return DataCache.current;\n    }\n\n    /**\n     * Sets the current cache service\n     * @param {*|DataCache} cacheService\n     */\n    setCurrent(cacheService) {\n        DataCache.current = cacheService;\n    }\n\n}\n\nexport class NoDataCache {\n    constructor() {\n        //\n    }\n\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string|*} key\n     * @returns {Observable}\n     */\n    get(key) {\n        return Rx.Observable.of();\n    }\n\n    /**\n     * Removes a cached value.\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Observable}\n     */\n    remove(key) {\n        return Rx.Observable.of();\n    }\n\n\n\n    /**\n     * Sets a key value pair in cache.\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    add(key, value, absoluteExpiration) {\n        return Rx.Observable.of();\n    }\n\n    /**\n     * Flush all cached data.\n     * @returns {Observable}\n     */\n    clear() {\n        return Rx.Observable.of();\n    }\n\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        const self = this;\n        Args.check(_.isFunction(fn),'Invalid argument. Expected function.');\n        let source = fn();\n        Args.check(source instanceof Observable, 'Invalid argument. Expected a valid observable.');\n        return source.flatMap((res) => {\n            if (_.isNil(res)) {\n                return Rx.Observable.of();\n            }\n            return Rx.Observable.of(res);\n        });\n    }\n\n\n}\n//set no data cache (by default)\nDataCache.current = new NoDataCache();\n//enable caching in node.js mode (this is the default behaviour)\nif (typeof window === 'undefined') {\n    DataCache.current = new DataCache();\n}\n//validates application instance\nif (global && global['application']) {\n    //get application\n    const application = global['application'];\n    //if application.getService method exists\n    if (_.isFunction(application.getService)) {\n        //override getCurrent() static method\n        DataCache.getCurrent = () => {\n            //and return application cache factory\n            return application.getService('$CacheFactory');\n        }\n    }\n}\n\n"]}