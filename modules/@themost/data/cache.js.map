{"version":3,"sources":["cache.es6"],"names":["SequentialEventEmitter","_","Args","Q","rawCacheProperty","Symbol","DataCache","initialized","callback","cacheModule","NodeCache","require","err","key","self","denodeify","init","set","flushAll","value","absoluteExpiration","fn","check","isFunction","get","then","res","isNil","source","add","result","bind","cacheService","current","NoDataCache","Observable","flatMap","Qf","window","global","application","getService","getCurrent"],"mappings":"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","file":"cache.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport 'source-map-support/register';\nimport {SequentialEventEmitter} from '@themost/common/emitter';\nimport {_} from 'lodash';\nimport {Args} from \"@themost/common/utils\";\nimport Q from 'q';\n\nconst rawCacheProperty = Symbol('rawCache');\n\n/**\n * @class\n * @classdesc Implements data cache mechanisms in MOST Data Applications.\n * DataCache class is used as the internal data caching engine, if any other caching mechanism is not defined.\n * @property {Number} ttl - An amount of time in seconds which is the default cached item lifetime.\n * @constructor\n * @augments EventEmitter2\n */\nexport class DataCache extends SequentialEventEmitter {\n\n    constructor() {\n        super();\n        this.initialized = false;\n    }\n\n    /**\n     * Initializes data caching.\n     * @param {Function} callback - A callback function where the first argument will contain the Error object if an error occured, or null otherwise.\n     * @private\n     */\n    init(callback) {\n        try {\n            if (this.initialized) {\n                return callback();\n            }\n            const cacheModule = \"node-cache\";\n            const NodeCache = require(cacheModule);\n            this[rawCacheProperty] = new NodeCache();\n            this.initialized = true;\n            return callback();\n        }\n        catch (err) {\n            callback(err);\n        }\n    }\n\n    /**\n     * Removes a cached value.\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Promise}\n     */\n    remove(key) {\n        const self = this;\n        return Q.denodeify((callback) => {\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].set(key, callback);\n            });\n        })();\n    }\n\n    /**\n     * Flush all cached data.\n     * @returns {Promise}\n     */\n    clear() {\n        const self = this;\n        return Q.denodeify((callback) => {\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].flushAll();\n                return callback();\n            });\n        })();\n    }\n\n    /**\n     * Sets a key value pair in cache.\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Promise}\n     */\n    add(key, value, absoluteExpiration) {\n        const self = this;\n        return Q.denodeify((callback) => {\n            self.init(function(err) {\n                if (err) {\n                    return callback(err);\n                }\n                self[rawCacheProperty].set(key, value, absoluteExpiration, callback);\n            });\n        })();\n    }\n\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Promise}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        const self = this;\n        Args.check(_.isFunction(fn),'Invalid argument. Expected function.');\n        return self.get(key).then((res) => {\n            if (_.isNil(res)) {\n                let source = fn();\n                Args.check(_.isFunction(source.then), 'Invalid argument. Expected a valid promise.');\n                return source.then((res) => {\n                    if (_.isNil(res)) {\n                        return Q();\n                    }\n                    return self.add(key,res,absoluteExpiration).then(() => {\n                        return Q(res);\n                    });\n                });\n            }\n            return Q(res);\n        });\n    }\n\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string|*} key\n     * @returns {Observable}\n     */\n    get(key) {\n        return Q.denodeify((function(key,callback) {\n            const self = this;\n            self.init((err) => {\n                if (err) {\n                    return callback(err);\n                }\n                return self[rawCacheProperty].get(key, function(err, result) {\n                    if (err) {\n                        return callback(err);\n                    }\n                    if (typeof result[key] !== 'undefined') {\n                        return callback(null, result[key]);\n                    }\n                    return callback();\n                });\n            });\n        }).bind(this))(key);\n    }\n\n    /**\n     * Returns the current cache service.\n     * @returns {*|DataCache}\n     */\n    static getCurrent() {\n        return DataCache.current;\n    }\n\n    /**\n     * Sets the current cache service\n     * @param {*|DataCache} cacheService\n     */\n    setCurrent(cacheService) {\n        DataCache.current = cacheService;\n    }\n\n}\n\nexport class NoDataCache {\n    constructor() {\n        //\n    }\n\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string|*} key\n     * @returns {Promise}\n     */\n    get(key) {\n        return Q();\n    }\n\n    /**\n     * Removes a cached value.\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Promise}\n     */\n    remove(key) {\n        return Q();\n    }\n\n\n\n    /**\n     * Sets a key value pair in cache.\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Promise}\n     */\n    add(key, value, absoluteExpiration) {\n        return Q();\n    }\n\n    /**\n     * Flush all cached data.\n     * @returns {Promise}\n     */\n    clear() {\n        return Q();\n    }\n\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Promise}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        const self = this;\n        Args.check(_.isFunction(fn),'Invalid argument. Expected function.');\n        let source = fn();\n        Args.check(source instanceof Observable, 'Invalid argument. Expected a valid observable.');\n        return source.flatMap((res) => {\n            if (_.isNil(res)) {\n                return Qf();\n            }\n            return Q(res);\n        });\n    }\n\n\n}\n//set no data cache (by default)\nDataCache.current = new NoDataCache();\n//enable caching in node.js mode (this is the default behaviour)\nif (typeof window === 'undefined') {\n    DataCache.current = new DataCache();\n}\n//validates application instance\nif (global && global['application']) {\n    //get application\n    const application = global['application'];\n    //if application.getService method exists\n    if (_.isFunction(application.getService)) {\n        //override getCurrent() static method\n        DataCache.getCurrent = () => {\n            //and return application cache factory\n            return application.getService('$CacheFactory');\n        }\n    }\n}\n\n"]}