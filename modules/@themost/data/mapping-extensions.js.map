{"version":3,"sources":["mapping-extensions.es6"],"names":["_","Q","QueryExpression","QueryField","QueryEntity","HasOneToManyAssociation","HasManyToOneAssociation","HasManyToManyAssociation","HasTagAssociation","MappingExtensions","mapping","thisQueryable","childModel_","parentModel_","for","dataQueryable","getChildModel","isNil","isObject","model","context","childModel","getParentModel","parentModel","getParents_v1","items","thisArg","deferred","defer","process","nextTick","resolve","arr","isArray","length","reject","name","associationType","values","filter","x","childField","map","junction","convert","getBaseModel","where","in","flatten","silent","all","err","junctions","intersection","options","q","prepare","$levels","parentField","$silent","getItems","then","parents","refersTo","forEach","valueId","p","y","r","z","indexOf","catch","promise","getParents","migrate","junctionQuery","create","select","join","query","as","with","equal","viewAdapter","hasFields","alsoSelect","from","getChilds_v1","value","childs","parentId","getChilds","getAssociatedParents","distinct","getAllItems","field","keyField","property","iterator","key","find","getAssociatedParents_v1","hasOwnProperty","selector","getAssociatedChilds_v1","foreignKeyField","getAssociatedChilds"],"mappings":"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","file":"mapping-extensions.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport 'source-map-support/register';\nimport {_} from 'lodash';\nimport Q from 'q';\nimport {QueryExpression,QueryField,QueryEntity} from '@themost/query/query';\nimport {HasOneToManyAssociation,HasManyToOneAssociation, HasManyToManyAssociation,HasTagAssociation} from './associations';\n\n\nexport class MappingExtensions {\n\n    /**\n     * @param {DataAssociationMapping|*} mapping\n     * @returns {*}\n     */\n    static extend(mapping) {\n        let thisQueryable, childModel_, parentModel_;\n        return {\n            /**\n             * @param {DataQueryable} dataQueryable\n             */\n            for: function(dataQueryable) {\n                thisQueryable = dataQueryable;\n                return this;\n            },\n            getChildModel: function() {\n                if (_.isNil(thisQueryable)) {\n                    return;\n                }\n                if (_.isObject(childModel_)) {\n                    return childModel_;\n                }\n                childModel_ = thisQueryable.model.context.model(mapping.childModel);\n                return childModel_;\n\n            },\n            getParentModel: function() {\n                if (_.isNil(thisQueryable)) {\n                    return;\n                }\n                if (_.isObject(parentModel_)) {\n                    return parentModel_;\n                }\n                parentModel_ = thisQueryable.model.context.model(mapping.parentModel);\n                return parentModel_;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getParents_v1: function(items) {\n\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.childModel !== thisQueryable.model.name) || (mapping.associationType!=='junction')) {\n                        return deferred.resolve();\n                    }\n                    //get array of key values (for childs)\n                    let values = arr.filter(function(x) {\n                        return (typeof x[mapping.childField]!=='undefined')\n                            && (x[mapping.childField]!=null); })\n                            .map(function(x) { return x[mapping.childField]\n                            });\n                    //query junction model\n                    const junction = new HasManyToOneAssociation(thisQueryable.model.convert({ }), mapping);\n                    junction.getBaseModel().where('valueId').in(values).flatten().silent().all(function(err, junctions) {\n                        if (err) { return deferred.reject(err); }\n                        //get array of parent key values\n                        values = _.intersection(junctions.map(function(x) { return x['parentId'] }));\n                        //get parent model\n                        const parentModel = thisArg.getParentModel();\n                        //query parent with parent key values\n                        parentModel.filter(mapping.options, function(err, q) {\n                            if (err) {\n                                return deferred.reject(err);\n                            }\n                            q.prepare();\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            q.where(mapping.parentField).in(values);\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //and finally query parent\n                            q.getItems().then(function(parents){\n                                //if result contains only one item\n                                if (arr.length == 1) {\n                                    arr[0][mapping.refersTo] = parents;\n                                    return deferred.resolve();\n                                }\n                                //otherwise loop result array\n                                arr.forEach(function(x) {\n                                    //get child (key value)\n                                    const valueId = x[mapping.childField];\n                                    //get parent(s)\n                                    const p = junctions.filter(function(y) { return (y.valueId==valueId); }).map(function(r) { return r['parentId']; });\n                                    //filter data and set property value (a filtered array of parent objects)\n                                    x[mapping.refersTo] = parents.filter(function(z) { return p.indexOf(z[mapping.parentField])>=0; });\n                                });\n                                return deferred.resolve();\n                            }).catch(function(err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getParents : function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.childModel !== thisQueryable.model.name) || (mapping.associationType!=='junction')) {\n                        return deferred.resolve();\n                    }\n                    const junction = new HasManyToOneAssociation(thisQueryable.model.convert({ }), mapping);\n                    return junction.migrate(function(err) {\n                        if (err) { return deferred.reject(err); }\n                        const parentModel = thisArg.getParentModel();\n                        parentModel.filter(mapping.options, function(err, q) {\n                            if (err) { return deferred.reject(err); }\n                            //get junction sub-query\n                            const junctionQuery = QueryExpression.create(junction.getBaseModel().name).select(\"parentId\", \"valueId\")\n                                .join(thisQueryable.query.as(\"j0\"))\n                                .with(QueryExpression.create().where(QueryEntity.create(junction.getBaseModel().name).select(\"valueId\"))\n                                    .equal(QueryEntity.create(\"j0\").select(mapping.childField)));\n                            //append join statement with sub-query\n                            q.query.join(junctionQuery.as(\"g0\"))\n                                .with(QueryExpression.create().where(QueryEntity.create(parentModel.viewAdapter).select(mapping.parentField))\n                                    .equal(QueryEntity.create(\"g0\").select(\"parentId\")));\n                            if (!q.query.hasFields()) {\n                                q.select();\n                            }\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //append child key field\n                            q.alsoSelect(QueryField.create(\"valueId\").from(\"g0\").as(\"ref__\"));\n                            return q.getItems().then(function (parents) {\n                                _.forEach(arr, function(x) {\n                                    x[mapping.refersTo] = _.filter(parents, function(y) {\n                                        if (y['ref__'] === x[mapping.childField]) {\n                                            delete y['ref__'];\n                                            return true;\n                                        }\n                                        return false;\n                                    });\n                                });\n                                return deferred.resolve();\n                            }).catch(function (err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getChilds_v1: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.parentModel !== thisQueryable.model.name) || (mapping.associationType!=='junction')) {\n                        return deferred.resolve();\n                    }\n                    const values = arr.filter(function(x) {\n                        return (typeof x[mapping.parentField]!=='undefined') && (x[mapping.parentField]!=null);\n                    }).map(function(x) {\n                        return x[mapping.parentField];\n                    });\n                    if (_.isNil(mapping.childModel)) {\n                        junction = new HasTagAssociation(thisQueryable.model.convert({ }), mapping);\n                        return junction.getBaseModel().where(\"object\").in(values).flatten().silent().select(\"object\", \"value\").all().then(function(items) {\n                            arr.forEach(function(x) {\n                                x[mapping.refersTo] = items.filter(function(y) {\n                                    return y[\"object\"]===x[mapping.parentField];\n                                }).map(function (y) {\n                                    return y.value;\n                                });\n                            });\n                            return deferred.resolve();\n                        }).catch(function (err) {\n                            return deferred.reject(err);\n                        });\n                    }\n                    //create a dummy object\n                    var junction = new HasManyToManyAssociation(thisQueryable.model.convert({ }), mapping);\n                    //query junction model\n                    return junction.getBaseModel().where('parentId').in(values).silent().flatten().getItems().then(function(junctions) {\n                        //get array of child key values\n                        const values = junctions.map(function(x) { return x['valueId'] });\n                        //get child model\n                        const childModel = thisArg.getChildModel();\n                        childModel.filter(mapping.options, function(err, q) {\n                            if (err) {\n                                return deferred.reject(err);\n                            }\n                            q.prepare();\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //append where statement for this operation\n                            if (values.length==1) {\n                                q.where(mapping.childField).equal(values[0]);\n                            }\n                            else {\n                                q.where(mapping.childField).in(values);\n                            }\n                            //and finally query childs\n                            q.getItems().then(function(childs) {\n                                //if result contains only one item\n                                if (arr.length == 1) {\n                                    arr[0][mapping.refersTo] = childs;\n                                    return deferred.resolve();\n                                }\n                                //otherwise loop result array\n                                arr.forEach(function(x) {\n                                    //get parent (key value)\n                                    const parentId = x[mapping.parentField];\n                                    //get parent(s)\n                                    const p = junctions.filter(function(y) { return (y.parentId==parentId); }).map(function(r) { return r['valueId']; });\n                                    //filter data and set property value (a filtered array of parent objects)\n                                    x[mapping.refersTo] = childs.filter(function(z) { return p.indexOf(z[mapping.childField])>=0; });\n                                });\n                                return deferred.resolve();\n                            }).catch(function(err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    }).catch(function (err) {\n                        return deferred.reject(err);\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getChilds: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.parentModel !== thisQueryable.model.name) || (mapping.associationType!=='junction')) {\n                        return deferred.resolve();\n                    }\n                    const junction = new HasManyToManyAssociation(thisQueryable.model.convert({ }), mapping);\n                    return junction.migrate(function(err) {\n                        if (err) { return deferred.reject(err); }\n                        const childModel = thisArg.getChildModel();\n                        childModel.filter(mapping.options, function(err, q) {\n                            if (err) { return deferred.reject(err); }\n                            if (!q.query.hasFields()) {\n                                q.select();\n                            }\n                            //get junction sub-query\n                            const junctionQuery = QueryExpression.create(junction.getBaseModel().name).select(\"parentId\", \"valueId\")\n                                .join(thisQueryable.query.as(\"j0\"))\n                                .with(QueryExpression.create().where(QueryEntity.create(junction.getBaseModel().name).select(\"parentId\"))\n                                    .equal(QueryEntity.create(\"j0\").select(mapping.parentField)));\n                            //append join statement with sub-query\n                            q.query.join(junctionQuery.as(\"g0\"))\n                                .with(QueryExpression.create().where(QueryEntity.create(childModel.viewAdapter).select(mapping.childField))\n                                    .equal(QueryEntity.create(\"g0\").select(\"valueId\")));\n\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //append item reference\n                            q.alsoSelect(QueryField.create(\"parentId\").from(\"g0\").as(\"ref__\"));\n                            return q.getItems().then(function (childs) {\n                                _.forEach(arr, function(x) {\n                                    x[mapping.refersTo] = _.filter(childs, function(y) {\n                                        if (y['ref__'] === x[mapping.parentField]) {\n                                            delete y['ref__'];\n                                            return true;\n                                        }\n                                        return false;\n                                    });\n                                });\n                                return deferred.resolve();\n                            }).catch(function (err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getAssociatedParents: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.childModel !== thisQueryable.model.name) || (mapping.associationType!=='association')) {\n                        return deferred.resolve();\n                    }\n                    thisArg.getParentModel().migrate(function(err) {\n                       if (err) { return deferred.reject(err); }\n                        thisArg.getParentModel().filter(mapping.options, function(err, q) {\n                           if (err) { return deferred.reject(err); }\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            q.query\n                               .distinct()\n                               .join(thisQueryable.query.as('j0'))\n                               .with(QueryExpression.create().where(QueryEntity.create(thisArg.getParentModel().viewAdapter).select(mapping.parentField))\n                                   .equal(QueryEntity.create(\"j0\").select(mapping.childField)));\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            q.silent().getAllItems().then(function(parents) {\n                                const childField = thisQueryable.model.field(mapping.childField);\n                                const keyField = childField.property || childField.name;\n                                const iterator = function(x) {\n                                    const key = x[keyField];\n                                    x[keyField] = _.find(parents, function(x) {\n                                       return x[mapping.parentField] === key;\n                                    });\n                                };\n                                _.forEach(arr, iterator);\n                                return deferred.resolve();\n                            }).catch(function (err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getAssociatedParents_v1: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.childModel !== thisQueryable.model.name) || (mapping.associationType!=='association')) {\n                        return deferred.resolve();\n                    }\n                    thisArg.getParentModel().migrate(function(err) {\n                        if (err) { return deferred.reject(err); }\n                        const childField = thisQueryable.model.field(mapping.childField);\n                        const keyField = childField.property || childField.name;\n                        if (_.isNil(childField)) {\n                            return deferred.reject(\"The specified field cannot be found on child model\");\n                        }\n                        const values = _.intersection(_.map(_.filter(arr, function(x) {\n                            return x.hasOwnProperty(keyField);\n                            }), function (x) { return x[keyField];}));\n                        if (values.length==0) {\n                            return deferred.resolve();\n                        }\n                        thisArg.getParentModel().filter(mapping.options, function(err, q) {\n                            if (err) {\n                                return deferred.reject(err);\n                            }\n                            q.prepare();\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //append where statement for this operation\n                            q.where(mapping.parentField).in(values);\n                            //set silent (?)\n                            q.silent().getAllItems().then(function(parents) {\n                                let key=null;\n\n                                const selector = function(x) {\n                                    return x[mapping.parentField]==key;\n                                };\n\n                                const iterator = function(x) {\n                                    key = x[keyField];\n                                    if (childField.property && childField.property!==childField.name) {\n                                        x[childField.property] = parents.filter(selector)[0];\n                                        delete x[childField.name];\n                                    }\n                                    else\n                                        x[childField.name] = parents.filter(selector)[0];\n                                };\n\n                                if (_.isArray(arr)) {\n                                    arr.forEach(iterator);\n                                }\n                                return deferred.resolve();\n                            }).catch(function(err) {\n                                return deferred.reject(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getAssociatedChilds_v1: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.parentModel !== thisQueryable.model.name) || (mapping.associationType!=='association')) {\n                        return deferred.resolve();\n                    }\n                    thisArg.getChildModel().migrate(function(err) {\n                        if (err) { return deferred.reject(err); }\n                        const parentField = thisQueryable.model.field(mapping.parentField);\n                        if (_.isNil(parentField)) {\n                            return deferred.reject(\"The specified field cannot be found on parent model\");\n                        }\n                        const keyField = parentField.property || parentField.name;\n                        const values = _.intersection(_.map(_.filter(arr, function(x) {\n                            return x.hasOwnProperty(keyField);\n                        }), function (x) { return x[keyField];}));\n                        if (values.length==0) {\n                            return deferred.resolve();\n                        }\n                        //search for view named summary\n                        thisArg.getChildModel().filter(mapping.options, function(err, q) {\n                            if (err) {\n                                return deferred.reject(err);\n                            }\n                            const childField = thisArg.getChildModel().field(mapping.childField);\n                            if (_.isNil(childField)) {\n                                return deferred.reject(\"The specified field cannot be found on child model\");\n                            }\n                            const foreignKeyField = childField.property || childField.name;\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            q.prepare();\n                            if (values.length==1) {\n                                q.where(mapping.childField).equal(values[0]);\n                            }\n                            else {\n                                q.where(mapping.childField).in(values);\n                            }\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //final execute query\n                            return q.getItems().then(function(childs) {\n                                _.forEach(arr, function(x) {\n                                    x[mapping.refersTo] = _.filter(childs, function(y) {\n                                        if (!_.isNil(y[foreignKeyField]) && y[foreignKeyField].hasOwnProperty(keyField)) {\n                                            return y[foreignKeyField][keyField] === x[keyField];\n                                        }\n                                        return y[foreignKeyField] === x[keyField];\n                                    });\n                                });\n                                return deferred.resolve();\n                            }).catch(function(err) {\n                                return deferred.resolve(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            },\n            /**\n             * @param {*} items\n             * @returns {Promise|*}\n             */\n            getAssociatedChilds: function(items) {\n                const thisArg = this;\n                const deferred = Q.defer();\n                process.nextTick(function() {\n                    if (_.isNil(items)) {\n                        return deferred.resolve();\n                    }\n                    const arr = _.isArray(items) ? items : [items];\n                    if (arr.length == 0) {\n                        return deferred.resolve();\n                    }\n                    if (_.isNil(thisQueryable)) {\n                        return deferred.reject('The underlying data queryable cannot be empty at this context.');\n                    }\n                    if ((mapping.parentModel !== thisQueryable.model.name) || (mapping.associationType!=='association')) {\n                        return deferred.resolve();\n                    }\n                    thisArg.getChildModel().migrate(function(err) {\n                        if (err) { return deferred.reject(err); }\n                        const parentField = thisArg.getParentModel().field(mapping.parentField);\n                        if (_.isNil(parentField)) {\n                            return deferred.reject(\"The specified field cannot be found on parent model\");\n                        }\n                        const keyField = parentField.property || parentField.name;\n                        const values = _.intersection(_.map(_.filter(arr, function(x) {\n                            return x.hasOwnProperty(keyField);\n                        }), function (x) { return x[keyField];}));\n                        if (values.length==0) {\n                            return deferred.resolve();\n                        }\n                        //search for view named summary\n                        thisArg.getChildModel().filter(mapping.options, function(err, q) {\n                            if (err) {\n                                return deferred.reject(err);\n                            }\n                            const childField = thisArg.getChildModel().field(mapping.childField);\n                            if (_.isNil(childField)) {\n                                return deferred.reject(\"The specified field cannot be found on child model\");\n                            }\n                            const foreignKeyField = childField.property || childField.name;\n                            //Important Backward compatibility issue (<1.8.0)\n                            //Description: if $levels parameter is not defined then set the default value to 0.\n                            if (typeof q.$levels === 'undefined') {\n                                q.$levels = 0;\n                            }\n                            if (!q.query.hasFields()) {\n                                q.select();\n                            }\n                            //inherit silent mode\n                            if (thisQueryable.$silent)  { q.silent(); }\n                            //join parents\n                            q.query.join(thisQueryable.query.as(\"j0\"))\n                                .with(QueryExpression.create().where(QueryEntity.create(thisArg.getChildModel().viewAdapter).select(mapping.childField))\n                                    .equal(QueryEntity.create(\"j0\").select(mapping.parentField)));\n                            q.prepare();\n                            //final execute query\n                            return q.getItems().then(function(childs) {\n                                _.forEach(arr, function(x) {\n                                    x[mapping.refersTo] = _.filter(childs, function(y) {\n                                        if (!_.isNil(y[foreignKeyField]) && y[foreignKeyField].hasOwnProperty(keyField)) {\n                                            return y[foreignKeyField][keyField] === x[keyField];\n                                        }\n                                        return y[foreignKeyField] === x[keyField];\n                                    });\n                                });\n                                return deferred.resolve();\n                            }).catch(function(err) {\n                                return deferred.resolve(err);\n                            });\n                        });\n                    });\n                });\n                return deferred.promise;\n            }\n        };\n    }\n};"]}