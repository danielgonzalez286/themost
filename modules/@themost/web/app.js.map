{"version":3,"sources":["app.es6"],"names":["HTTP_SERVER_DEFAULT_BIND","HTTP_SERVER_DEFAULT_PORT","handleRequestInternal","request","response","callback","self","context","createContext","url","indexOf","assign","params","parse","substring","form","files","processRequest","err","listeners","length","onError","end","emit","error","finalize","createRequestInternal","options","opt","IncomingMessage","method","httpVersion","headers","host","accept","connection","cookie","cookies","session","query","body","createResponseInternal","req","ServerResponse","htmlErrorInternal","isNil","ejs","require","test","readFile","join","__dirname","readErr","data","log","str","render","httpErr","message","stack","e","writeHead","status","write","startInternal","config","init","opts","bind","process","env","IP","port","PORT","server_","createServer","getServer","listen","format","call","httpApplicationErrors","application","html","onHtmlError","text","NODE_ENV","isEmpty","innerMessage","json","result","mvc","HttpJsonResult","code","execute","unauthorized","settings","auth","page","loginPage","HttpRedirectResult","concat","encodeURIComponent","HttpHandler","Events","HttpDataContext","name","type","ApplicationOptions","ApplicationConfig","adapters","engines","mimes","handlers","routes","adapterTypes","dataTypes","locales","HttpApplication","executionPath","cwd","configPath","ng","module","service","$context","providerPath","provider","mapPath","svc","createInstance","Error","$cache","cache","Object","defineProperty","get","HttpCache","set","value","configurable","enumerable","development","errors","crypto","randomHex","cfg","current","defaultApplicationConfig","defaultHandlers","i","item","filter","x","push","forEach","h","handlerPath","handlerModule","handler","default","HandlerCtor","directives","apply","s","uri","pathname","file","exists","stat","stats","isFile","md5","createHash","update","mtime","toString","digest","requestETag","prototype","resolveETag","extensionName","extname","arr","extension","algorithm","key","cipher","createCipher","final","decipher","createDecipher","username","defaultOptions","user","dateCreated","Date","expires","JSON","stringify","_extend","isDate","toUTCString","encrypt","setHeader","decrypt","currentHandler","er","resource","adapter","find","invariantName","adapterType","m","ev","j","on","https","httpModule","protocol","res","setEncoding","chunk","statusCode","encoding","fn","account","unattendedExecutionAccount","authenticationType","extensionFolder","existsSync","readdirSync","extensionPath","hostname","path","executeExternalRequest","_header","split","header","k","substr","isArray","output","outputEncodings","_headerSent","cluster","clusters","cpus","parseInt","isMaster","debug","execArgv","debugPort","exec","setupMaster","fork","pop","ctor","directive","controllers","c","__current__","global","extend"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport {_} from 'lodash';\nimport util from 'util';\nimport http from 'http';\nimport path from 'path';\nimport fs from 'fs';\nimport url from 'url';\nimport async from 'async';\nimport querystring from 'querystring';\nimport crypto from 'crypto';\nimport {SequentialEventEmitter} from '@themost/common/emitter';\nimport {TraceUtils,RandomUtils,LangUtils} from '@themost/common/utils';\nimport {HttpError,HttpServerError,HttpNotFoundError} from '@themost/common/errors';\nimport {HttpContext} from './context';\nimport da from 'most-data';\n\n\nconst HTTP_SERVER_DEFAULT_BIND = '127.0.0.1';\nconst HTTP_SERVER_DEFAULT_PORT = 3000;\n\n/**\n * @private\n * @param {ClientRequest} request\n * @param {ServerResponse} response\n * @param callback\n */\nfunction handleRequestInternal(request, response, callback)\n{\n    const self = this, context = self.createContext(request, response);\n    //add query string\n    if (request.url.indexOf('?') > 0)\n        _.assign(context.params, querystring.parse(request.url.substring(request.url.indexOf('?') + 1)));\n    //add form\n    if (request.form)\n        _.assign(context.params, request.form);\n    //add files\n    if (request.files)\n        _.assign(context.params, request.files);\n\n    self.processRequest(context, function (err) {\n        if (err) {\n            if (self.listeners('error').length == 0) {\n                self.onError(context, err, function () {\n                    response.end();\n                    callback();\n                });\n            }\n            else {\n                //raise application error event\n                self.emit('error', { context:context, error:err } , function () {\n                    response.end();\n                    callback();\n                });\n            }\n        }\n        else {\n            context.finalize(function() {\n                response.end();\n                callback();\n            });\n        }\n    });\n}\n/**\n * @private\n * @param {*} options\n */\nfunction createRequestInternal(options) {\n    const opt = options ? options : {};\n    const request = new http.IncomingMessage();\n    request.method = (opt.method) ? opt.method : 'GET';\n    request.url = (opt.url) ? opt.url : '/';\n    request.httpVersion = '1.1';\n    request.headers = (opt.headers) ? opt.headers : {\n            host: 'localhost',\n            'user-agent': 'Mozilla/5.0 (X11; Linux i686; rv:10.0) Gecko/20100101 Firefox/22.0',\n            accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n            'accept-language': 'en-US,en;q=0.5',\n            'accept-encoding': 'gzip, deflate',\n            connection: 'keep-alive',\n            'cache-control': 'max-age=0' };\n    if (opt.cookie)\n        request.headers.cookie = opt.cookie;\n    request.cookies = (opt.cookies) ? opt.cookies : {};\n    request.session = (opt.session) ? opt.session : {};\n    request.params = (opt.params) ? opt.params : {};\n    request.query = (opt.query) ? opt.query : {};\n    request.form = (opt.form) ? opt.form : {};\n    request.body = (opt.body) ? opt.body : {};\n    request.files = (opt.files) ? opt.files : {};\n    return request;\n}\n\n/**\n * Creates a mock-up server response\n * @param {ClientRequest} req\n * @returns {ServerResponse|*}\n * @private\n */\nfunction createResponseInternal(req) {\n    return new http.ServerResponse(req);\n}\n\n/**\n *\n * @param {HttpContext} context\n * @param {Error|*} err\n * @param {function(Error=)} callback\n * @private\n */\nfunction htmlErrorInternal(context, err, callback) {\n    try {\n        if (_.isNil(context)) {\n            callback(err);\n            return;\n        }\n        const request = context.request, response = context.response, ejs = require('ejs');\n        if (_.isNil(request) || _.isNil(response)) {\n            callback(err);\n            return;\n        }\n        //HTML custom errors\n        if (/text\\/html/g.test(request.headers.accept)) {\n            fs.readFile(path.join(__dirname, './resources/http-error.html.ejs'), 'utf8', function (readErr, data) {\n                if (readErr) {\n                    //log process error\n                    TraceUtils.log(readErr);\n                    //continue error execution\n                    callback(err);\n                    return;\n                }\n                //compile data\n                let str;\n                try {\n                    if (err instanceof HttpError) {\n                        str = ejs.render(data, { error:err });\n                    }\n                    else {\n                        const httpErr = new HttpError(500, null, err.message);\n                        httpErr.stack = err.stack;\n                        str = ejs.render(data, {error: httpErr});\n                    }\n                }\n                catch (e) {\n                    TraceUtils.log(e);\n                    //continue error execution\n                    callback(err);\n                    return;\n                }\n                //write status header\n                response.writeHead(err.status || 500 , { \"Content-Type\": \"text/html\" });\n                response.write(str);\n                response.end();\n                callback();\n            });\n        }\n        else {\n            callback(err);\n        }\n    }\n    catch (e) {\n        //log process error\n        TraceUtils.log(e);\n        //and continue execution\n        callback(err);\n    }\n\n}\n\n\n\n\n/**\n * @private\n * @param {Function=} callback\n * @param {ApplicationOptions|*} options\n */\nfunction startInternal(options, callback) {\n    const self = this;\n    callback = callback || function() { };\n    try {\n        //validate options\n\n        if (self.config == null)\n            self.init();\n        /**\n         * @memberof process.env\n         * @property {number} PORT\n         * @property {string} IP\n         * @property {string} NODE_ENV\n         */\n        const opts = {\n            bind:(process.env.IP || HTTP_SERVER_DEFAULT_BIND),\n            port:(process.env.PORT ? process.env.PORT: HTTP_SERVER_DEFAULT_PORT)\n        };\n        //extend options\n        _.assign(opts, options);\n\n        const server_ = http.createServer(function (request, response) {\n            const context = self.createContext(request, response);\n            //begin request processing\n            self.processRequest(context, function (err) {\n                if (err) {\n                    //handle context error event\n                    if (context.listeners('error').length>0) {\n                        return context.emit('error', { error:err }, function() {\n                            context.finalize(function() {\n                                if (context.response) { context.response.end(); }\n                            });\n                        });\n                    }\n                    if (self.listeners('error').length == 0) {\n                        self.onError(context, err, function () {\n                            if (typeof context === 'undefined' || context == null) { return; }\n                            context.finalize(function() {\n                                if (context.response) { context.response.end(); }\n                            });\n                        });\n                    }\n                    else {\n                        //raise application error event\n                        self.emit('error', { context:context, error:err }, function() {\n                            if (typeof context === 'undefined' || context == null) { return; }\n                            context.finalize(function() {\n                                if (context.response) { context.response.end(); }\n                            });\n                        });\n                    }\n                }\n                else {\n                    if (typeof context === 'undefined' || context == null) { return; }\n                    context.finalize(function() {\n                        if (context.response) { context.response.end(); }\n                    });\n                }\n            });\n        });\n        /**\n         * @memberof {HttpApplication}\n         * @returns {Server|*}\n         */\n        self.getServer = function() {\n            return server_;\n        };\n\n        //start listening\n        server_.listen(opts.port, opts.bind);\n        TraceUtils.log(util.format('Web application is running at http://%s:%s/', opts.bind, opts.port));\n        //do callback\n        callback.call(self);\n    } catch (e) {\n        TraceUtils.log(e);\n    }\n}\n\n/**\n * @param {HttpApplication} application\n * @returns {{html: Function, text: Function, json: Function, unauthorized: Function}}\n * @private\n */\nfunction httpApplicationErrors(application) {\n    const self = application;\n    return {\n        html: function(context, error, callback) {\n            callback = callback || function () { };\n            onHtmlError(context, error, function(err) {\n                callback.call(self, err);\n            });\n        },\n        text: function(context, error, callback) {\n            callback = callback || function () { };\n            /**\n             * @type {ServerResponse}\n             */\n            const response = context.response;\n            if (error) {\n                //send plain text\n                response.writeHead(error.status || 500, {\"Content-Type\": \"text/plain\"});\n                //if error is an HTTP Exception\n                if (error instanceof HttpError) {\n                    response.write(error.status + ' ' + error.message + \"\\n\");\n                }\n                else {\n                    //otherwise send status 500\n                    response.write('500 ' + error.message + \"\\n\");\n                }\n                //send extra data (on development)\n                if (process.env.NODE_ENV === 'development') {\n                    if (!_.isEmpty(error.innerMessage)) {\n                        response.write(error.innerMessage + \"\\n\");\n                    }\n                    if (!_.isEmpty(error.stack)) {\n                        response.write(error.stack + \"\\n\");\n                    }\n                }\n            }\n            callback.call(this);\n        },\n        json: function(context, error, callback) {\n            callback = callback || function () { };\n            context.request.headers = context.request.headers || { };\n            if (/application\\/json/g.test(context.request.headers.accept)) {\n                //prepare JSON result\n                let result;\n                if ((err instanceof HttpError) || (typeof err.status !== 'undefined')) {\n                    result = new mvc.HttpJsonResult({ status:error.status, code:error.code, message:error.message, innerMessage: error.innerMessage });\n                }\n                else if (process.env.NODE_ENV === 'development') {\n                    result = new mvc.HttpJsonResult(err);\n                }\n                else {\n                    result = new mvc.HttpJsonResult(new HttpServerError());\n                }\n                //execute redirect result\n                result.execute(context, function(err) {\n                    callback.call(self, err);\n                });\n                return;\n            }\n            //go to next error if any\n            callback.call(self, error);\n        },\n        unauthorized: function(context, error, callback) {\n            if (_.isNil(context) || _.isNil(context)) {\n                return callback.call(self);\n            }\n            if (error.status != 401) {\n                //go to next error if any\n                return callback.call(self, error);\n            }\n            context.request.headers = context.request.headers || { };\n            if (/text\\/html/g.test(context.request.headers.accept)) {\n                if (self.config.settings) {\n                    if (self.config.settings.auth) {\n                        //get login page from configuration\n                        const page = self.config.settings.auth.loginPage || '/login.html';\n                        //prepare redirect result\n                        const result = new mvc.HttpRedirectResult(page.concat('?returnUrl=', encodeURIComponent(context.request.url)));\n                        //execute redirect result\n                        result.execute(context, function(err) {\n                            callback.call(self, err);\n                        });\n                        return;\n                    }\n                }\n            }\n            //go to next error if any\n            callback.call(self, error);\n        }\n    }\n}\n\n\n/**\n * @classdesc An abstract class that represents an HTTP Handler\n * @class\n * @abstract\n */\nexport class HttpHandler {\n    /**\n     * Occurs as the first event in the HTTP execution\n     * @constructor\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    beginRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when a handler is going to validate current HTTP request.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    validateRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when a handler is going to set current user identity.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    authenticateRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when a handler has established the identity of the current user.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    /*HttpHandler.prototype.postAuthenticateRequest = function(context, callback) {\n     callback = callback || function() {};\n     callback.call(context);\n     };*/\n\n\n    /**\n     * Occurs when a handler has verified user authorization.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    authorizeRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when the handler is selected to respond to the request.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    mapRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when application has mapped the current request to the appropriate handler.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    postMapRequest(context, callback) {\n        callback = callback || function() {};\n        callback.call(context);\n    }\n\n    /**\n     * Occurs just before application starts executing a handler.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    /*HttpHandler.prototype.preRequestHandlerExecute = function(context, callback) {\n     callback = callback || function() {};\n     callback.call(context);\n     };*/\n\n    /**\n     * Occurs when application starts processing current HTTP request.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    processRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when application starts executing an HTTP Result.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    preExecuteResult(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when application was succesfully executes an HTTP Result.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    postExecuteResult(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n\n    /**\n     * Occurs when the handler finishes execution.\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    /*HttpHandler.prototype.postRequestHandlerExecute = function(context, callback) {\n     callback = callback || function() {};\n     callback.call(context);\n     };*/\n\n    /**\n     * Occurs as the last event in the HTTP execution\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    endRequest(context, callback) {\n        callback = callback || function () {\n            };\n        callback.call(context);\n    }\n}\n\n\n/**\n * @type {string[]}\n * @private\n */\nHttpHandler.Events = ['beginRequest', 'validateRequest', 'authenticateRequest',\n    'authorizeRequest', 'mapRequest', 'postMapRequest', 'preExecuteResult', 'postExecuteResult', 'endRequest'];\n\n/**\n * @class\n * @classdesc Abstract class that represents a data context\n * @abstract\n */\nexport class HttpDataContext {\n    /**\n     * @returns {AbstractAdapter}\n     */\n    db() {\n        return null;\n    }\n\n    /**\n     * @param {string} name\n     * @returns {DataModel}\n     */\n    model(name) {\n        return null;\n    }\n\n    /**\n     * @param {string} type\n     * @returns {*}\n     */\n    dataTypes(type) {\n        return null;\n    }\n}\n\n\n/**\n * @classdesc ApplicationOptions class describes the startup options of a MOST Web Framework application.\n * @class\n * @property {number} port - The HTTP binding port number.\n * The default value is either PORT environment variable or 3000.\n * @property {string} bind - The HTTP binding ip address or hostname.\n * The default value is either IP environment variable or 127.0.0.1.\n * @property {number|string} cluster - A number which represents the number of clustered applications.\n * The default value is zero (no clustering). If cluster is 'auto' then the number of clustered applications\n * depends on hardware capabilities (number of CPUs).\n @example\n import {HttpApplication} from '@themost/web/app';\n var app = new HttpApplication();\n app.start({ port:80, bind:\"0.0.0.0\",cluster:'auto' });\n @example\n //Environment variables already set: IP=198.51.100.0 PORT=80\n import {HttpApplication} from '@themost/web/app';\n var app = new HttpApplication();\n app.start();\n */\nexport class ApplicationOptions {\n    constructor() {\n\n    }\n}\n/**\n * @classdesc Represents HttpApplication configuration\n * @class\n */\nexport class ApplicationConfig {\n    constructor() {\n        /**\n         * Gets an array of data adapters.\n         * @type {Array}\n         */\n        this.adapters = [];\n        /**\n         * Gets an array of HTTP view engines configuration\n         * @type {Array}\n         */\n        this.engines = [];\n        /**\n         *  Gets an array of all registered MIME types\n         * @type {Array}\n         */\n        this.mimes = [];\n        /**\n         * Gets an array of all registered HTTP handlers.\n         * @type {Array}\n         */\n        this.handlers = [];\n        /**\n         * Gets an array of all registered HTTP routes.\n         * @type {Array}\n         */\n        this.routes = [];\n        /**\n         * Gets or sets a collection of data adapter types that are going to be use in data operation\n         * @type {Array}\n         */\n        this.adapterTypes = null;\n        /**\n         * Gets or sets a collection of data types that are going to be use in data operation\n         * @type {Array}\n         */\n        this.dataTypes = null;\n        /**\n         * Gets or sets an object that holds application settings\n         * @type {Array}\n         */\n        this.settings = { };\n        /**\n         * Gets or sets an object that holds application locales\n         * @type {*}\n         */\n        this.locales = { };\n    }\n}\n\n/**\n * @class\n * @property {string} executionPath - Gets or sets a string which represents the current execution path\n * @property {string} configPath - Gets or sets a string which represents the current configuration path\n * @augments EventEmitter\n */\nexport class HttpApplication extends SequentialEventEmitter {\n    /**\n     * @constructor\n     */\n    constructor() {\n        super();\n        this.executionPath = path.join(process.cwd(), 'app');\n        /**\n         * Gets the current application configuration path\n         * @type {*}\n         */\n        this.configPath = path.join(process.cwd(), 'app');\n        /**\n         * Gets or sets application configuration settings\n         * @type {ApplicationConfig}\n         */\n        this.config = null;\n        /**\n         * Gets or sets a collection of application handlers\n         * @type {Array}\n         */\n        this.handlers = [];\n\n        //initialize angular server module\n        const ng = require('./angular/server_module');\n        /**\n         * @type {AngularServerModule}\n         */\n        this.module = null;\n        //init module\n        ng.init(this);\n        //register auth service\n        const self = this;\n        self.module.service('$auth', function($context) {\n            try {\n                //ensure settings\n                self.config.settings.auth = self.config.settings.auth || { };\n                let providerPath = self.config.settings.auth.provider || './services/auth';\n                //get auth provider\n                if (providerPath.indexOf('/')==0)\n                    providerPath = self.mapPath(providerPath);\n                const svc = require(providerPath);\n                if (typeof svc.createInstance !== 'function')\n                    throw new Error('Invalid authentication provider module.');\n                return svc.createInstance($context);\n            }\n            catch (e) {\n                throw e;\n            }\n        });\n        /**\n         * @type {HttpCache}\n         */\n        let $cache;\n        self.module.service('$cache', function() {\n            try {\n                return self.cache;\n            }\n            catch (e) {\n                throw e;\n            }\n        });\n\n\n        Object.defineProperty(self, 'cache', {\n            get: function () {\n                if (!_.isNil($cache))\n                    return $cache;\n                const HttpCache = require( \"./services/cache\" );\n                /**\n                 * @type {HttpCache|*}\n                 */\n                $cache = new HttpCache();\n                return $cache;\n            },\n            set: function(value) {\n                $cache = value;\n            },\n            configurable: false,\n            enumerable: false\n        });\n        /**\n         * Gets or sets a boolean that indicates whether the application is in development mode\n         * @type {string}\n         */\n        this.development = (process.env.NODE_ENV === 'development');\n        /**\n         *\n         * @type {{html, text, json, unauthorized}|*}\n         */\n        this.errors = httpApplicationErrors(this);\n\n\n\n\n    }\n\n    /**\n     * Initializes application configuration.\n     * @return {HttpApplication}\n     */\n    init() {\n        /**\n         * Gets or sets application configuration settings\n         */\n            //get node environment\n        const env = process.env['NODE_ENV'] || 'production';\n\n        let str;\n        //first of all try to load environment specific configuration\n        try {\n            TraceUtils.log(util.format('Init: Loading environment specific configuration file (app.%s.json)', env));\n            str = path.join(process.cwd(), 'config', 'app.' + env + '.json');\n            /**\n             * @type {ApplicationConfig}\n             */\n            this.config = require(str);\n            TraceUtils.log(util.format('Init: Environment specific configuration file (app.%s.json) was succesfully loaded.', env));\n        }\n        catch (e) {\n            if (e.code === 'MODULE_NOT_FOUND') {\n                TraceUtils.log(util.format('Init: Environment specific configuration file (app.%s.json) is missing.', env));\n                //try to load default configuration file\n                try {\n                    TraceUtils.log('Init: Loading environment default configuration file (app.json)');\n                    str = path.join(process.cwd(), 'config', 'app.json');\n                    /**\n                     * @type {ApplicationConfig}\n                     */\n                    this.config = require(str);\n                    TraceUtils.log('Init: Default configuration file (app.json) was succesfully loaded.');\n                }\n                catch (e) {\n                    if (e.code === 'MODULE_NOT_FOUND') {\n                        TraceUtils.log('Init: An error occured while loading default configuration (app.json). Configuration cannot be found or is inaccesible.');\n                        //load internal configuration file\n                        /**\n                         * @type {ApplicationConfig}\n                         */\n                        this.config = require('./resources/app.json');\n                        this.config.settings.crypto = {\n                            \"algorithm\": \"aes256\",\n                            \"key\": RandomUtils.randomHex(32)\n                        };\n                        TraceUtils.log('Init: Internal configuration file (app.json) was succesfully loaded.');\n                    }\n                    else {\n                        TraceUtils.log('Init: An error occured while loading default configuration (app.json)');\n                        throw e;\n                    }\n                }\n            }\n            else {\n                TraceUtils.log(util.format('Init: An error occured while loading application specific configuration (app).', env));\n                throw e;\n            }\n        }\n        //load routes (if empty)\n        if (_.isNil(this.config.routes)) {\n            try {\n                this.config.routes = require(path.join(process.cwd(),'config/routes.json'));\n            }\n            catch(e) {\n                if (e.code === 'MODULE_NOT_FOUND') {\n                    //load internal default route file\n                    TraceUtils.log('Init: Application specific routes configuration cannot be found. The default routes configuration will be loaded instead.');\n                    this.config.routes = require('./resources/routes.json');\n                }\n                else {\n                    TraceUtils.log('Init: An error occured while trying to load application routes configuration.');\n                    throw e;\n                }\n            }\n        }\n        //load data types (if empty)\n        if (_.isNil(this.config.dataTypes))\n        {\n            try {\n                this.config.dataTypes = da.cfg.current.dataTypes;\n            }\n            catch(e) {\n                TraceUtils.log('Init: An error occured while trying to load application data types configuration.');\n                throw e;\n            }\n        }\n\n        //set settings default\n        this.config.settings = this.config.settings || {};\n\n        //initialize handlers list\n        //important note: Applications handlers are static classes (they will be initialized once),\n        //so they should not hold information about http context and execution lifecycle.\n        const self = this;\n\n        const handlers = self.config.handlers || [], defaultApplicationConfig = require('./resources/app.json');\n        //default handlers\n        const defaultHandlers = defaultApplicationConfig.handlers;\n        for (let i = 0; i < defaultHandlers.length; i++) {\n            (function(item) {\n                if (typeof handlers.filter(function(x) { return x.name === item.name; })[0] === 'undefined') {\n                    handlers.push(item);\n                }\n            })(defaultHandlers[i]);\n        }\n        _.forEach(handlers, function (h) {\n            try {\n                let handlerPath = h.type;\n                if (handlerPath.indexOf('/')==0)\n                    handlerPath = self.mapPath(handlerPath);\n                const handlerModule = require(handlerPath);\n                let handler = null;\n                if (handlerModule) {\n                    if (typeof handlerModule.default != 'function') {\n                        TraceUtils.log(util.format('The specified handler (%s) cannot be instantiated. The module does not export default constructor.', h.name));\n                        return;\n                    }\n                    const HandlerCtor = handlerModule.default;\n                    handler = new HandlerCtor();\n                    if (handler)\n                        self.handlers.push(handler);\n                }\n            }\n            catch (e) {\n                throw new Error(util.format('The specified handler (%s) cannot be loaded. %s', h.name, e.message));\n            }\n        });\n        //initialize basic directives collection\n        const directives = require(\"./angular/server_directives\");\n        directives.apply(this);\n        return this;\n    }\n\n    /**\n     * Returns the path of a physical file based on a given URL.\n     */\n    mapPath(s) {\n        const uri = url.parse(s).pathname;\n        return path.join(this.executionPath, uri);\n    }\n\n    /**\n     * Resolves ETag header for the given file. If the specifed does not exist or is invalid returns null.\n     * @param {string=} file - A string that represents the file we want to query\n     * @param {function(Error,string=)} callback\n     */\n    resolveETag(file, callback) {\n        fs.exists(file, function(exists) {\n            try {\n                if (exists) {\n                    fs.stat(file, function(err, stats) {\n                        if (err) {\n                            callback(err);\n                        }\n                        else {\n                            if (!stats.isFile()) {\n                                callback(null);\n                            }\n                            else {\n                                //validate if-none-match\n                                const md5 = crypto.createHash('md5');\n                                md5.update(stats.mtime.toString());\n                                const result = md5.digest('base64');\n                                callback(null, result);\n\n                            }\n                        }\n                    });\n                }\n                else {\n                    callback(null);\n                }\n            }\n            catch (e) {\n                callback(null);\n            }\n        });\n    }\n\n    /**\n     * @param {HttpContext} context\n     * @param {string} executionPath\n     * @param {function(Error, Boolean)} callback\n     */\n    unmodifiedRequest(context, executionPath, callback) {\n        try {\n            const requestETag = context.request.headers['if-none-match'];\n            if (typeof requestETag === 'undefined' || requestETag == null) {\n                callback(null, false);\n                return;\n            }\n            HttpApplication.prototype.resolveETag(executionPath, function(err, result) {\n                callback(null, (requestETag==result));\n            });\n        }\n        catch (e) {\n            TraceUtils.log(e);\n            callback(null, false);\n        }\n    }\n\n    /**\n     * @param request {String|IncomingMessage}\n     * */\n    resolveMime(request) {\n        if (typeof request=== 'string') {\n            //get file extension\n            var extensionName = path.extname(request);\n            var arr = this.config.mimes.filter(function(x) {\n                return (x.extension == extensionName);\n            });\n            if (arr.length>0)\n                return arr[0];\n            return null;\n        }\n        else if (typeof request=== 'object') {\n            //get file extension\n            var extensionName = path.extname(request.url);\n            var arr = this.config.mimes.filter(function(x) {\n                return (x.extension == extensionName);\n            });\n            if (arr.length>0)\n                return arr[0];\n            return null;\n        }\n    }\n\n    /**\n     * Encrypts the given data\n     * */\n    encrypt(data) {\n        if (typeof data === 'undefined' || data==null)\n            return null;\n        //validate settings\n        if (!this.config.settings.crypto)\n            throw new Error('Data encryption configuration section is missing. The operation cannot be completed');\n        if (!this.config.settings.crypto.algorithm)\n            throw new Error('Data encryption algorithm is missing. The operation cannot be completed');\n        if (!this.config.settings.crypto.key)\n            throw new Error('Data encryption key is missing. The operation cannot be completed');\n        //encrypt\n        const cipher = crypto.createCipher(this.config.settings.crypto.algorithm, this.config.settings.crypto.key);\n        return cipher.update(data, 'utf8', 'hex') + cipher.final('hex');\n    }\n\n    /**\n     * Decrypts the given data.\n     * */\n    decrypt(data) {\n        if (typeof data === 'undefined' || data==null)\n            return null;\n        //validate settings\n        if (!this.config.settings.crypto)\n            throw new Error('Data encryption configuration section is missing. The operation cannot be completed');\n        if (!this.config.settings.crypto.algorithm)\n            throw new Error('Data encryption algorithm is missing. The operation cannot be completed');\n        if (!this.config.settings.crypto.key)\n            throw new Error('Data encryption key is missing. The operation cannot be completed');\n        //decrypt\n        const decipher = crypto.createDecipher(this.config.settings.crypto.algorithm, this.config.settings.crypto.key);\n        return decipher.update(data, 'hex', 'utf8') + decipher.final('utf8');\n    }\n\n    /**\n     * Sets the authentication cookie that is associated with the given user.\n     * @param {HttpContext} context\n     * @param {String} username\n     * @param {*=} options\n     */\n    setAuthCookie(context, username, options) {\n        const defaultOptions = { user:username, dateCreated:new Date()};\n        let value;\n        let expires;\n        if (typeof options !== 'undefined' && options != null) {\n            value = JSON.stringify(util._extend(options, defaultOptions));\n            if (util.isDate(options.expires)) {\n                expires = options.expires.toUTCString();\n            }\n        }\n        else {\n            value = JSON.stringify(defaultOptions);\n        }\n        const settings = this.config.settings ? (this.config.settings.auth || { }) : { };\n        settings.name = settings.name || '.MAUTH';\n        let str = settings.name.concat('=', this.encrypt(value)) + ';path=/';\n        if (typeof expires === 'string') {\n            str +=';expires=' + expires;\n        }\n        context.response.setHeader('Set-Cookie',str);\n    }\n\n    /**\n     * Sets the authentication cookie that is associated with the given user.\n     * @param {HttpContext} context\n     * @param {String} username\n     */\n    getAuthCookie(context) {\n        try {\n            const settings = this.config.settings ? (this.config.settings.auth || { }) : { };\n            settings.name = settings.name || '.MAUTH';\n            const cookie = context.cookie(settings.name);\n            if (cookie) {\n                return this.decrypt(cookie);\n            }\n            return null;\n        }\n        catch(e) {\n            TraceUtils.log('GetAuthCookie failed.');\n            TraceUtils.log(e.message);\n            return null;\n        }\n    }\n\n    /**\n     *\n     * @param {HttpContext} context\n     * @param {Function} callback\n     */\n    processRequest(context, callback) {\n        const self = this;\n        if (typeof context === 'undefined' || context == null) {\n            callback.call(self);\n        }\n        else {\n            //1. beginRequest\n            context.emit('beginRequest', context, function (err) {\n                if (err) {\n                    callback.call(context, err);\n                }\n                else {\n                    //2. validateRequest\n                    context.emit('validateRequest', context, function (err) {\n                        if (err) {\n                            callback.call(context, err);\n                        }\n                        else {\n                            //3. authenticateRequest\n                            context.emit('authenticateRequest', context, function (err) {\n                                if (err) {\n                                    callback.call(context, err);\n                                }\n                                else {\n                                    //4. authorizeRequest\n                                    context.emit('authorizeRequest', context, function (err) {\n                                        if (err) {\n                                            callback.call(context, err);\n                                        }\n                                        else {\n                                            //5. mapRequest\n                                            context.emit('mapRequest', context, function (err) {\n                                                if (err) {\n                                                    callback.call(context, err);\n                                                }\n                                                else {\n                                                    //5b. postMapRequest\n                                                    context.emit('postMapRequest', context, function(err) {\n                                                        if (err) {\n                                                            callback.call(context, err);\n                                                        }\n                                                        else {\n                                                            //process HEAD request\n                                                            if (context.request.method==='HEAD') {\n                                                                //7. endRequest\n                                                                context.emit('endRequest', context, function (err) {\n                                                                    callback.call(context, err);\n                                                                });\n                                                            }\n                                                            else {\n                                                                //6. processRequest\n                                                                if (context.request.currentHandler != null)\n                                                                    context.request.currentHandler.processRequest(context, function (err) {\n                                                                        if (err) {\n                                                                            callback.call(context, err);\n                                                                        }\n                                                                        else {\n                                                                            //7. endRequest\n                                                                            context.emit('endRequest', context, function (err) {\n                                                                                callback.call(context, err);\n                                                                            });\n                                                                        }\n                                                                    });\n                                                                else {\n                                                                    const er = new HttpNotFoundError();\n                                                                    if (context.request && context.request.url) {\n                                                                        er.resource = context.request.url;\n                                                                    }\n                                                                    callback.call(context, er);\n                                                                }\n                                                            }\n\n                                                        }\n                                                    });\n                                                }\n                                            });\n                                        }\n                                    });\n                                }\n                            });\n                        }\n                    });\n                }\n            });\n        }\n    }\n\n    /**\n     * Gets the default data context based on the current configuration\n     * @returns {AbstractAdapter}\n     */\n    db() {\n        if ((this.config.adapters == null) || (this.config.adapters.length == 0))\n            throw new Error('Data adapters configuration settings are missing or cannot be accessed.');\n        let adapter = null;\n        if (this.config.adapters.length == 1) {\n            //there is only one adapter so try to instantiate it\n            adapter = this.config.adapters[0];\n        }\n        else {\n            adapter = _.find(this.config.adapters, function (x) {\n                return x.default;\n            });\n        }\n        if (_.isEmpty(adapter))\n            throw new Error('There is no default data adapter or the configuration is incorrect.');\n        //try to instantiate adapter\n        if (!adapter.invariantName)\n            throw new Error('The default data adapter has no invariant name.');\n        const adapterType = this.config.adapterTypes[adapter.invariantName];\n        if (adapterType == null)\n            throw new Error('The default data adapter type cannot be found.');\n        if (typeof adapterType.createInstance === 'function') {\n            return adapterType.createInstance(adapter.options);\n        }\n        else if (adapterType.require) {\n            const m = require(adapterType.require);\n            if (typeof m.createInstance === 'function') {\n                return m.createInstance(adapter.options);\n            }\n            throw new Error('The default data adapter cannot be instantiated. The module provided does not export a function called createInstance().')\n        }\n    }\n\n    /**\n     * Creates an instance of HttpContext class.\n     * @param {ClientRequest} request\n     * @param {ServerResponse} response\n     * @returns {HttpContext}\n     */\n    createContext(request, response) {\n        const context = new HttpContext(request, response);\n        //set context application\n        context.application = this;\n        //set handler events\n        for (let i = 0; i < HttpHandler.Events.length; i++) {\n            const ev = HttpHandler.Events[i];\n            for (let j = 0; j < this.handlers.length; j++) {\n                const handler = this.handlers[j];\n                if (typeof handler[ev] === 'function') {\n                    context.on(ev, handler[ev]);\n                }\n\n            }\n        }\n        return context;\n    }\n\n    /**\n     * @param {*} options\n     * @param {*} data\n     * @param {Function} callback\n     */\n    executeExternalRequest(options, data, callback) {\n        //make request\n        const https = require('https'), opts = (typeof options==='string') ? url.parse(options) : options, httpModule = (opts.protocol === 'https:') ? https : http;\n        const req = httpModule.request(opts, function(res) {\n            res.setEncoding('utf8');\n            let data = '';\n            res.on('data', function (chunk) {\n                data += chunk;\n            });\n            res.on('end', function(){\n                const result = {\n                    statusCode: res.statusCode,\n                    headers: res.headers,\n                    body:data,\n                    encoding:'utf8'\n                };\n                /**\n                 * destroy sockets (manually close an unused socket) ?\n                 */\n                callback(null, result);\n            });\n        });\n        req.on('error', function(e) {\n            //return error\n            callback(e);\n        });\n        if(data)\n        {\n            if (typeof data ===\"object\" )\n                req.write(JSON.stringify(data));\n            else\n                req.write(data.toString());\n        }\n        req.end();\n    }\n\n    /**\n     * Executes an internal process\n     * @param {function(HttpContext)} fn\n     */\n    execute(fn) {\n        const request = createRequestInternal.call(this);\n        fn.call(this, this.createContext(request, createResponseInternal.call(this,request)));\n    }\n\n    /**\n     * Executes an unattended internal process\n     * @param {function(HttpContext)} fn\n     */\n    unattended(fn) {\n        //create context\n        const request = createRequestInternal.call(this), context =  this.createContext(request, createResponseInternal.call(this,request));\n        //get unattended account\n        /**\n         * @type {{unattendedExecutionAccount:string}|*}\n         */\n        this.config.settings.auth = this.config.settings.auth || {};\n        const account = this.config.settings.auth.unattendedExecutionAccount;\n        //set unattended execution account\n        if (typeof account !== 'undefined' || account!==null) {\n            context.user = { name: account, authenticationType: 'Basic'};\n        }\n        //execute internal process\n        fn.call(this, context);\n    }\n\n    /**\n     * Load application extension\n     */\n    extend(extension) {\n        if (typeof extension === 'undefined')\n        {\n            //register all application extensions\n            const extensionFolder = this.mapPath('/extensions');\n            if (fs.existsSync(extensionFolder)) {\n                const arr = fs.readdirSync(extensionFolder);\n                for (let i = 0; i < arr.length; i++) {\n                    if (path.extname(arr[i])=='.js')\n                        require(path.join(extensionFolder, arr[i]));\n                }\n            }\n        }\n        else {\n            //register the specified extension\n            if (typeof extension === 'string') {\n                const extensionPath = this.mapPath(util.format('/extensions/%s.js', extension));\n                if (fs.existsSync(extensionPath)) {\n                    //load extension\n                    require(extensionPath);\n                }\n            }\n        }\n        return this;\n    }\n\n    /**\n     *\n     * @param {*|string} options\n     * @param {Function} callback\n     */\n    executeRequest(options, callback) {\n        const opts = { };\n        if (typeof options === 'string') {\n            util._extend(opts, { url:options });\n        }\n        else {\n            util._extend(opts, options);\n        }\n        const request = createRequestInternal.call(this,opts), response = createResponseInternal.call(this,request);\n        if (!opts.url) {\n            callback(new Error('Internal request url cannot be empty at this context.'));\n            return;\n        }\n        if (opts.url.indexOf('/')!=0)\n        {\n            const uri = url.parse(opts.url);\n            opts.host = uri.host;\n            opts.hostname = uri.hostname;\n            opts.path = uri.path;\n            opts.port = uri.port;\n            //execute external request\n            this.executeExternalRequest(opts,null, callback);\n        }\n        else {\n            //todo::set cookie header (for internal requests)\n            /*\n             IMPORTANT: set response Content-Length to -1 in order to force the default HTTP response format.\n             if the content length is unknown (server response does not have this header)\n             in earlier version of node.js <0.11.9 the response contains by default a hexademical number that\n             represents the content length. This number appears exactly after response headers and before response body.\n             If the content length is defined the operation omits this hexademical value\n             e.g. the wrong or custom formatted response\n             HTTP 1.1 Status OK\n             Content-Type: text/html\n             ...\n             Connection: keep-alive\n\n             6b8\n\n             <html><body>\n             ...\n             </body></html>\n             e.g. the standard format\n             HTTP 1.1 Status OK\n             Content-Type: text/html\n             ...\n             Connection: keep-alive\n\n\n             <html><body>\n             ...\n             </body></html>\n             */\n            response.setHeader('Content-Length',-1);\n            handleRequestInternal.call(this, request, response, function(err) {\n                if (err) {\n                    callback(err);\n                }\n                else {\n                    try {\n                        //get statusCode\n                        const statusCode = response.statusCode;\n                        //get headers\n                        const headers = {};\n                        if (response._header) {\n                            const arr = response._header.split('\\r\\n');\n                            for (let i = 0; i < arr.length; i++) {\n                                const header = arr[i];\n                                if (header) {\n                                    const k = header.indexOf(':');\n                                    if (k>0) {\n                                        headers[header.substr(0,k)] = header.substr(k+1);\n                                    }\n                                }\n                            }\n                        }\n                        //get body\n                        let body = null;\n                        let encoding = null;\n                        if (util.isArray(response.output)) {\n                            if (response.output.length>0) {\n                                body = response.output[0].substr(response._header.length);\n                                encoding = response.outputEncodings[0];\n                            }\n                        }\n                        //build result (something like ServerResponse)\n                        const result = {\n                            statusCode: statusCode,\n                            headers: headers,\n                            body:body,\n                            encoding:encoding\n                        };\n                        callback(null, result);\n                    }\n                    catch (e) {\n                        callback(e);\n                    }\n                }\n            });\n        }\n    }\n\n    /**\n     *\n     * @param {HttpContext} context\n     * @param {Error|HttpError} err\n     * @param {function()} callback\n     */\n    onError(context, err, callback) {\n        callback = callback || function () { };\n        try {\n            if (err instanceof Error) {\n                //always log error\n                TraceUtils.log(err);\n                //get response object\n                const response = context.response, ejs = require('ejs');\n                if (_.isNil(response)) {\n                    callback.call(this);\n                }\n                if (response._headerSent) {\n                    callback.call(this);\n                    return;\n                }\n                htmlErrorInternal(context, err, function(err) {\n                    if (err) {\n                        //send plain text\n                        response.writeHead(err.status || 500, {\"Content-Type\": \"text/plain\"});\n                        //if error is an HTTP Exception\n                        if (err instanceof HttpError) {\n                            response.write(err.status + ' ' + err.message + \"\\n\");\n                        }\n                        else {\n                            //otherwise send status 500\n                            response.write('500 ' + err.message + \"\\n\");\n                        }\n                        //send extra data (on development)\n                        if (process.env.NODE_ENV === 'development') {\n                            if (!_.isEmpty(err.innerMessage)) {\n                                response.write(err.innerMessage + \"\\n\");\n                            }\n                            if (!_.isEmpty(err.stack)) {\n                                response.write(err.stack + \"\\n\");\n                            }\n                        }\n                    }\n                    callback.call(this);\n                });\n\n\n            }\n            else {\n                callback.call(this);\n            }\n        }\n        catch (e) {\n            TraceUtils.log(e);\n            if (context.response) {\n                context.response.writeHead(500, {\"Content-Type\": \"text/plain\"});\n                context.response.write(\"500 Internal Server Error\");\n                callback.call(this);\n            }\n        }\n    }\n\n    /**\n     * @param {*=} options\n     * @param {Function=} callback\n     */\n    start(options, callback) {\n        callback = callback || function() { };\n        options = options || {};\n        if (options.cluster) {\n            let clusters = 1;\n            //check if options.cluster=\"auto\"\n            if (/^auto$/i.test(options.cluster)) {\n                clusters = require('os').cpus().length;\n            }\n            else {\n                //get cluster number\n                clusters = LangUtils.parseInt(options.cluster);\n            }\n            if (clusters>1) {\n                const cluster = require('cluster');\n                if (cluster.isMaster) {\n                    //get debug argument (if any)\n                    const debug = process.execArgv.filter(function(x) { return /^--debug(-brk)?=\\d+$/.test(x); })[0];\n\n                    let debugPort;\n                    if (debug) {\n                        //get debug port\n                        debugPort = parseInt(/^--debug(-brk)?=(\\d+)$/.exec(debug)[2]);\n                        cluster.setupMaster({\n                            execArgv: process.execArgv.filter(function(x) { return !/^--debug(-brk)?=\\d+$/.test(x); })\n                        });\n                    }\n                    for (let i = 0; i < clusters; i++) {\n                        if (debug) {\n                            if (/^--debug-brk=/.test(debug))\n                                cluster.settings.execArgv.push('--debug-brk=' + (debugPort + i));\n                            else\n                                cluster.settings.execArgv.push('--debug=' + (debugPort + i));\n                        }\n                        cluster.fork();\n                        if (debug) cluster.settings.execArgv.pop();\n                    }\n                } else {\n                    startInternal.call(this,options, callback);\n                }\n            }\n            else {\n                startInternal.call(this,options, callback);\n            }\n        }\n        else {\n            startInternal.call(this,options, callback);\n        }\n    }\n\n    /**\n     * @param {string} name\n     * @param {function=} ctor - The class constructor associated with this controller\n     * @returns {HttpApplication|function()}\n     */\n    service(name, ctor) {\n        if (typeof ctor === 'undefined')\n            return this.module.service(name);\n        this.module.service(name, ctor);\n        return this;\n    }\n\n    /**\n     * @param {string} name\n     * @param {function} ctor - The class constructor associated with this controller\n     * @returns {HttpApplication|function()}\n     */\n    directive(name, ctor) {\n        this.module.directive(name, ctor);\n        return this;\n    }\n\n    /**\n     * Get or sets an HTTP controller\n     * @param {string} name\n     * @param {Function|*} ctor\n     * @returns {*}\n     */\n    controller(name, ctor) {\n        this.config.controllers = this.config.controllers || {};\n        let er;\n        if (typeof ctor === 'undefined') {\n            const c = this.config.controllers[name];\n            if (typeof c === 'string') {\n                return require(c);\n            }\n            else if (typeof c === 'function') {\n                return c;\n            }\n            else {\n                er =  new Error('Invalid HTTP Controller constructor. Expected string or function.'); er.code='EARG';\n                throw er;\n            }\n        }\n        //if ctor is not a function (constructor) throw invalid argument exception\n        if (typeof ctor !== 'function') {\n            er =  new Error('Invalid HTTP Controller constructor. Expected function.'); er.code='EARG';\n            throw er;\n        }\n        //append controller to application constroller (or override an already existing controller)\n        this.config.controllers[name] = ctor;\n        return this;\n    }\n}\n\n/**\n * @type HttpApplication\n * @private\n */\nlet __current__ = null;\n\nif (typeof global !== 'undefined' && global!=null) {\n    if (typeof global.application === 'undefined') {\n        //set current application as global property (globals.application)\n        Object.defineProperty(global, 'application', {\n            get: function () {\n                return HttpApplication.current;\n            },\n            configurable: false,\n            enumerable: false\n        });\n    }\n}\n\nObject.defineProperty(HttpApplication, 'current', {\n    get: function () {\n        if (__current__ != null)\n            return __current__;\n        //instantiate HTTP application\n        __current__ = new HttpApplication();\n        //initialize current application\n        if (__current__.config == null)\n            __current__.init();\n        //extend current application\n        __current__.extend();\n        //and finally return it\n        return __current__;\n    },\n    configurable: false,\n    enumerable: false\n});"]}