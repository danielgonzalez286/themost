{"version":3,"sources":["server_directives.es6"],"names":["apply","_","toBoolean","value","length","v","lowercase","getBlockElements","angular","nodes","startNode","endNode","element","elements","nextSibling","push","app","module","directive","$context","$angular","$qs","$sce","replace","restrict","link","scope","attrs","src","ejsInclude","deferred","defer","application","executeRequest","url","cookie","request","headers","err","result","replaceWith","reject","message","removeAttr","body","resolve","priority","$eval","$animate","$document","transclude","terminal","$$tlb","$scope","$element","$attr","ctrl","$transclude","block","childScope","previousElements","ejsIf","parentDocument","get","$watch","ngIfWatchAction","$new","clone","createComment","enter","parent","remove","$destroy","leave","$compile","model","mask","state","compile","pre","preLink","DataPermissionEventListener","require","classes","targetModel","isNil","p","e","throwError","validate","contents","post","noop","title","attr","translate","ejsLoc","placeholder","text","html","ejsLocHtml","user","groups","roles","ejsUserInRole","split","inRole","filter","x","indexOf","name","forEach","y","substr"],"mappings":"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","file":"server_directives.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport {_} from 'lodash';\n\nfunction toBoolean(value) {\n    if (typeof value === 'function') {\n        value = true;\n    } else if (value && value.length !== 0) {\n        const v = lowercase(\"\" + value);\n        value = !(v == 'f' || v == '0' || v == 'false' || v == 'no' || v == 'n' || v == '[]');\n    } else {\n        value = false;\n    }\n    return value;\n}\nfunction getBlockElements(angular, nodes) {\n    const startNode = nodes[0], endNode = nodes[nodes.length - 1];\n    if (startNode === endNode) {\n        return angular.element(startNode);\n    }\n\n    let element = startNode;\n    const elements = [element];\n\n    do {\n        element = element.nextSibling;\n        if (!element) break;\n        elements.push(element);\n    } while (element !== endNode);\n\n    return angular.element(elements);\n}\n/**\n * @param {HttpApplication} app\n */\nexport function apply(app) {\n    app.module.directive('ejsInclude', function($context, $angular, $qs, $sce) {\n        return {\n            replace:true,\n            restrict:'EA',\n            link: function (scope, element, attrs) {\n                /**\n                 * @ngdoc attrs\n                 * @property {string} ejsInclude\n                 * @property {string} src\n                 */\n                const src = attrs.ejsInclude || attrs.src;\n                if (src) {\n                    const deferred = $qs.defer();\n                    $context.application.executeRequest( { url: src, cookie: $context.request.headers.cookie }, function(err, result) {\n                        if (err) {\n                            element.replaceWith(null);\n                            deferred.reject(err.message);\n                        }\n                        else {\n                            element.removeAttr('data-src');\n                            element.replaceWith($angular.element(result.body.replace(/\\n/,'')));\n                            deferred.resolve();\n                        }\n                    });\n                }\n            }\n        };\n    }).directive('ejsInit', function() {\n        return {\n            priority:400,\n            restrict:'A',\n            link: function (scope, element, attrs) {\n                scope.$eval(attrs['ejsInit']);\n            }\n        };\n    }).directive('ejsIf', function($animate, $document) {\n        return {\n            transclude: 'element',\n            priority: 600,\n            terminal: true,\n            restrict: 'A',\n            $$tlb: true,\n            link: function ($scope, $element, $attr, ctrl, $transclude) {\n                let block, childScope, previousElements;\n                const ejsIf = $attr['ejsIf'], parentDocument = $document.get(0);\n                $scope.$watch(ejsIf, function ngIfWatchAction(value) {\n                    if (toBoolean(value)) {\n                        if (!childScope) {\n                            childScope = $scope.$new();\n                            $transclude(childScope, function (clone) {\n                                clone.push(parentDocument.createComment(''));\n                                //clone[clone.length++] = parentDocument.createComment('');\n                                block = {\n                                    clone: clone\n                                };\n                                $animate.enter(clone, $element.parent(), $element);\n                            });\n                        }\n                    } else {\n                        if (previousElements) {\n                            previousElements.remove();\n                            previousElements = null;\n                        }\n                        if (childScope) {\n                            childScope.$destroy();\n                            childScope = null;\n                        }\n                        if (block) {\n                            previousElements = getBlockElements(angular, block.clone);\n                            $animate.leave(previousElements, function () {\n                                previousElements = null;\n                            });\n                            block = null;\n                        }\n                    }\n                });\n            }\n        };\n    }).directive('ejsIfPermission', ['$context','$compile', '$qs', function($context, $compile, $qs) {\n        return {\n            restrict:'E',\n            replace: true,\n            scope: { model:'@',mask:'@',state:'@' },\n            compile:function() {\n                return {\n                    pre: function preLink(scope, element) {\n                        const DataPermissionEventListener = require('most-data').classes.DataPermissionEventListener;\n                        const deferred = $qs.defer();\n                        try {\n                            const targetModel = $context.model(scope.model);\n                            if (_.isNil(scope.state)) {\n                                if (scope.mask)\n                                    if (scope.mask == 1)\n                                        scope.state = 0;\n                                    else if (scope.mask == 2)\n                                        scope.state = 1;\n                                    else if (scope.mask == 4)\n                                        scope.state = 2;\n                                    else if (scope.mask == 8)\n                                        scope.state = 4;\n                                    else\n                                        scope.state = scope.mask;\n                            }\n                            const p = new DataPermissionEventListener(), e = { model: targetModel, state: scope.state, throwError:false };\n\n\n\n                            p.validate(e, function(err) {\n                                if (e.result) {\n                                    const result = $compile(element.contents())(scope);\n                                    element.replaceWith(result);\n                                    deferred.resolve();\n                                }\n                                else {\n                                    element.replaceWith(null);\n                                    deferred.resolve();\n                                }\n                            });\n                        }\n                        catch(err) {\n                            deferred.reject(err.message);\n                        }\n\n\n                    },\n                    post: angular.noop\n                }\n            }\n        };\n    }]).directive('ejsLoc', ['$context', function($context) {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attrs) {\n                /**\n                 * @ngdoc\n                 * @name attrs\n                 * @property {string} ejsLoc\n                 * @private\n                 */\n                if (attrs.title)\n                    element.attr('title', $context.translate(attrs.title, attrs.ejsLoc));\n                if (attrs.placeholder)\n                    element.attr('placeholder', $context.translate(attrs.placeholder, attrs.ejsLoc));\n            }\n        };\n    }]).directive('ejsLocHtml', ['$context', function($context) {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attrs) {\n                /**\n                 * @ngdoc\n                 * @name attrs\n                 * @property {string} ejsLocHtml\n                 * @private\n                 */\n                const text = $context.translate(element.html(), attrs.ejsLocHtml);\n                if (text)\n                    element.html(text);\n            }\n        };\n    }]).directive('ejsUserInRole', ['$context', '$compile', function($context, $compile) {\n        return {\n            restrict:'A',\n            replace: true,\n            priority: 100,\n            compile:function() {\n                return {\n                    pre: function preLink(scope, element, attrs) {\n                        const user = $context.user;\n                        if (typeof user !== 'undefined') {\n                            user.groups = user.groups || [];\n                            /**\n                             * @ngdoc attrs\n                             * @property {string} ejsUserInRole\n                             *\n                             * @type {Array}\n                             * @private\n                             */\n                            const roles = (attrs.ejsUserInRole || '').split(',');\n                            let inRole = (user.groups.filter(function(x) {\n                                return (roles.indexOf(x.name)>=0);\n                            }).length>0);\n                            //validate not statement e.g. ejs-user-in-role='!Administrators'\n                            if (!inRole) {\n                                roles.forEach(function(x) {\n                                    if (!inRole) {\n                                        if (x.indexOf('!')==0) {\n                                            inRole = (user.groups.filter(function(y) {\n                                                return (x.substr(1).indexOf(y.name)>=0);\n                                            }).length==0);\n                                        }\n                                    }\n                                });\n                            }\n                            if (!inRole) {\n                                element.replaceWith(null);\n                            }\n                            else {\n                                //do nothing (remove server attributes)\n                                element.removeAttr('ejs-user-in-role').removeAttr('ejs:user-in-role');\n                            }\n                        }\n                    },\n                    post: angular.noop\n                }\n            }\n        };\n    }]);\n}\n"]}