{"version":3,"sources":["directives.es6"],"names":["_","toBoolean","value","length","v","lowercase","getBlockElements","angular","nodes","startNode","endNode","element","elements","nextSibling","push","AngularServerModuleDefaults","module","directive","$context","$angular","$qs","$parse","replace","restrict","link","scope","attrs","src","serverInclude","deferred","defer","getApplication","executeRequest","url","cookie","request","headers","subscribe","result","removeAttr","replaceWith","body","resolve","err","reject","message","priority","$eval","$animate","$document","transclude","terminal","$$tlb","$scope","$element","$attr","ctrl","$transclude","block","childScope","previousElements","serverIf","parentDocument","get","$watch","ngIfWatchAction","$new","clone","createComment","enter","parent","remove","$destroy","leave","$compile","model","mask","state","compile","pre","preLink","DataPermissionEventListener","require","classes","targetModel","isNil","p","e","throwError","validate","contents","post","noop","title","attr","translate","serverLoc","placeholder","text","html","serverLocHtml","user","groups","roles","serverUserInRole","split","inRole","filter","x","indexOf","name","forEach","y","substr"],"mappings":"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","file":"directives.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport {_} from 'lodash';\n\nfunction toBoolean(value) {\n    if (typeof value === 'function') {\n        value = true;\n    } else if (value && value.length !== 0) {\n        const v = lowercase(\"\" + value);\n        value = !(v == 'f' || v == '0' || v == 'false' || v == 'no' || v == 'n' || v == '[]');\n    } else {\n        value = false;\n    }\n    return value;\n}\nfunction getBlockElements(angular, nodes) {\n    const startNode = nodes[0], endNode = nodes[nodes.length - 1];\n    if (startNode === endNode) {\n        return angular.element(startNode);\n    }\n\n    let element = startNode;\n    const elements = [element];\n\n    do {\n        element = element.nextSibling;\n        if (!element) break;\n        elements.push(element);\n    } while (element !== endNode);\n\n    return angular.element(elements);\n}\n\nexport class AngularServerModuleDefaults {\n    /**\n     * @param {AngularServerModule} module\n     */\n    static applyDirectives(module) {\n        module.directive('serverInclude', function($context, $angular, $qs, $parse) {\n            return {\n                replace:true,\n                restrict:'EA',\n                link: function (scope, element, attrs) {\n                    /**\n                     * @ngdoc attrs\n                     * @property {string} serverInclude\n                     * @property {string} src\n                     */\n                    const src = $parse(attrs.serverInclude)(scope);\n                    if (src) {\n                        const deferred = $qs.defer();\n                        $context.getApplication().executeRequest({\n                            url: src,\n                            cookie: $context.request.headers.cookie\n                        }).subscribe((result)=>{\n                            element.removeAttr('data-src');\n                            element.replaceWith($angular.element(result.body.replace(/\\n/,'')));\n                            deferred.resolve();\n                        }, (err) => {\n                            element.replaceWith(null);\n                            deferred.reject(err.message);\n                        });\n                    }\n                }\n            };\n        }).directive('serverInit', function() {\n            return {\n                priority:400,\n                restrict:'A',\n                link: function (scope, element, attrs) {\n                    scope.$eval(attrs['ejsInit']);\n                }\n            };\n        }).directive('serverIf', function($animate, $document) {\n            return {\n                transclude: 'element',\n                priority: 600,\n                terminal: true,\n                restrict: 'A',\n                $$tlb: true,\n                link: function ($scope, $element, $attr, ctrl, $transclude) {\n                    let block, childScope, previousElements;\n                    const serverIf = $attr['serverIf'], parentDocument = $document.get(0);\n                    $scope.$watch(serverIf, function ngIfWatchAction(value) {\n                        if (toBoolean(value)) {\n                            if (!childScope) {\n                                childScope = $scope.$new();\n                                $transclude(childScope, function (clone) {\n                                    clone.push(parentDocument.createComment(''));\n                                    //clone[clone.length++] = parentDocument.createComment('');\n                                    block = {\n                                        clone: clone\n                                    };\n                                    $animate.enter(clone, $element.parent(), $element);\n                                });\n                            }\n                        } else {\n                            if (previousElements) {\n                                previousElements.remove();\n                                previousElements = null;\n                            }\n                            if (childScope) {\n                                childScope.$destroy();\n                                childScope = null;\n                            }\n                            if (block) {\n                                previousElements = getBlockElements(angular, block.clone);\n                                $animate.leave(previousElements, function () {\n                                    previousElements = null;\n                                });\n                                block = null;\n                            }\n                        }\n                    });\n                }\n            };\n        }).directive('serverIfPermission', ['$context','$compile', '$qs', function($context, $compile, $qs) {\n            return {\n                restrict:'E',\n                replace: true,\n                scope: { model:'@',mask:'@',state:'@' },\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element) {\n                            const DataPermissionEventListener = require('most-data').classes.DataPermissionEventListener;\n                            const deferred = $qs.defer();\n                            try {\n                                const targetModel = $context.model(scope.model);\n                                if (_.isNil(scope.state)) {\n                                    if (scope.mask)\n                                        if (scope.mask == 1)\n                                            scope.state = 0;\n                                        else if (scope.mask == 2)\n                                            scope.state = 1;\n                                        else if (scope.mask == 4)\n                                            scope.state = 2;\n                                        else if (scope.mask == 8)\n                                            scope.state = 4;\n                                        else\n                                            scope.state = scope.mask;\n                                }\n                                const p = new DataPermissionEventListener(), e = { model: targetModel, state: scope.state, throwError:false };\n\n\n\n                                p.validate(e, function(err) {\n                                    if (e.result) {\n                                        const result = $compile(element.contents())(scope);\n                                        element.replaceWith(result);\n                                        deferred.resolve();\n                                    }\n                                    else {\n                                        element.replaceWith(null);\n                                        deferred.resolve();\n                                    }\n                                });\n                            }\n                            catch(err) {\n                                deferred.reject(err.message);\n                            }\n\n\n                        },\n                        post: angular.noop\n                    }\n                }\n            };\n        }]).directive('serverLoc', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLoc\n                     * @private\n                     */\n                    if (attrs.title)\n                        element.attr('title', $context.translate(attrs.title, attrs.serverLoc));\n                    if (attrs.placeholder)\n                        element.attr('placeholder', $context.translate(attrs.placeholder, attrs.serverLoc));\n                }\n            };\n        }]).directive('serverLocHtml', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLocHtml\n                     * @private\n                     */\n                    const text = $context.translate(element.html(), attrs.serverLocHtml);\n                    if (text)\n                        element.html(text);\n                }\n            };\n        }]).directive('serverUserInRole', ['$context', '$compile', function($context, $compile) {\n            return {\n                restrict:'A',\n                replace: true,\n                priority: 100,\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element, attrs) {\n                            const user = $context.user;\n                            if (typeof user !== 'undefined') {\n                                user.groups = user.groups || [];\n                                /**\n                                 * @ngdoc attrs\n                                 * @property {string} serverUserInRole\n                                 *\n                                 * @type {Array}\n                                 * @private\n                                 */\n                                const roles = (attrs.serverUserInRole || '').split(',');\n                                let inRole = (user.groups.filter(function(x) {\n                                    return (roles.indexOf(x.name)>=0);\n                                }).length>0);\n                                //validate not statement e.g. server-user-in-role='!Administrators'\n                                if (!inRole) {\n                                    roles.forEach(function(x) {\n                                        if (!inRole) {\n                                            if (x.indexOf('!')==0) {\n                                                inRole = (user.groups.filter(function(y) {\n                                                    return (x.substr(1).indexOf(y.name)>=0);\n                                                }).length==0);\n                                            }\n                                        }\n                                    });\n                                }\n                                if (!inRole) {\n                                    element.replaceWith(null);\n                                }\n                                else {\n                                    //do nothing (remove server attributes)\n                                    element.removeAttr('server-user-in-role').removeAttr('server:user-in-role');\n                                }\n                            }\n                        },\n                        post: angular.noop\n                    }\n                }\n            };\n        }]);\n    }\n}\n"]}