{"version":3,"sources":["directives.es6"],"names":["_","DataPermissionEventListener","toBoolean","value","length","v","lowercase","getBlockElements","angular","nodes","startNode","endNode","element","elements","nextSibling","push","AngularServerModuleDefaults","module","directive","$context","$async","$parse","replace","restrict","link","scope","attrs","resolve","reject","src","serverInclude","getApplication","executeRequest","url","cookie","request","headers","subscribe","result","removeAttr","replaceWith","body","err","message","priority","$eval","serverInit","$animate","$document","transclude","terminal","$$tlb","$scope","$element","$attr","ctrl","$transclude","block","childScope","previousElements","serverIf","parentDocument","get","$watch","ngIfWatchAction","$new","clone","createComment","enter","parent","remove","$destroy","leave","$compile","model","mask","state","compile","pre","preLink","targetModel","isNil","p","e","throwError","validate","contents","post","noop","title","attr","translate","serverLoc","placeholder","text","html","serverLocHtml","user","groups","roles","serverUserInRole","split","inRole","filter","x","indexOf","name","forEach","y","substr"],"mappings":"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","file":"directives.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport 'source-map-support/register';\nimport {_} from 'lodash';\nimport {DataPermissionEventListener} from '@themost/data/permission';\n\nfunction toBoolean(value) {\n    if (typeof value === 'function') {\n        value = true;\n    } else if (value && value.length !== 0) {\n        const v = lowercase(\"\" + value);\n        value = !(v == 'f' || v == '0' || v == 'false' || v == 'no' || v == 'n' || v == '[]');\n    } else {\n        value = false;\n    }\n    return value;\n}\nfunction getBlockElements(angular, nodes) {\n    const startNode = nodes[0], endNode = nodes[nodes.length - 1];\n    if (startNode === endNode) {\n        return angular.element(startNode);\n    }\n\n    let element = startNode;\n    const elements = [element];\n\n    do {\n        element = element.nextSibling;\n        if (!element) break;\n        elements.push(element);\n    } while (element !== endNode);\n\n    return angular.element(elements);\n}\n\nexport class AngularServerModuleDefaults {\n    /**\n     * @param {AngularServerModule} module\n     */\n    static applyDirectives(module) {\n        module.directive('serverInclude', function($context, $async, $parse) {\n            return {\n                replace:true,\n                restrict:'EA',\n                link: function (scope, element, attrs) {\n                    return $async(function(resolve, reject) {\n                        //get angular instance\n                        const angular = this.angular;\n                        /**\n                         * @ngdoc attrs\n                         * @property {string} serverInclude\n                         * @property {string} src\n                         */\n                        const src = $parse(attrs.serverInclude)(scope);\n                        if (src) {\n                            $context.getApplication().executeRequest({\n                                url: src,\n                                cookie: $context.request.headers.cookie\n                            }).subscribe((result)=>{\n                                element.removeAttr('data-src');\n                                element.replaceWith(angular.element(result.body.replace(/\\n/,'')));\n                                resolve();\n                            }, (err) => {\n                                element.replaceWith(null);\n                                reject(err.message);\n                            });\n                        }\n                    });\n                }\n            };\n        }).directive('serverInit', function() {\n            return {\n                priority:400,\n                restrict:'A',\n                link: function (scope, element, attrs) {\n                    /**\n                     * @ngdoc attrs\n                     * @property {string} serverInit\n                     */\n                    scope.$eval(attrs.serverInit);\n                }\n            };\n        }).directive('serverIf', function($animate, $document) {\n            return {\n                transclude: 'element',\n                priority: 600,\n                terminal: true,\n                restrict: 'A',\n                $$tlb: true,\n                link: function ($scope, $element, $attr, ctrl, $transclude) {\n                    let block, childScope, previousElements;\n                    const serverIf = $attr['serverIf'], parentDocument = $document.get(0);\n                    $scope.$watch(serverIf, function ngIfWatchAction(value) {\n                        if (toBoolean(value)) {\n                            if (!childScope) {\n                                childScope = $scope.$new();\n                                $transclude(childScope, function (clone) {\n                                    clone.push(parentDocument.createComment(''));\n                                    //clone[clone.length++] = parentDocument.createComment('');\n                                    block = {\n                                        clone: clone\n                                    };\n                                    $animate.enter(clone, $element.parent(), $element);\n                                });\n                            }\n                        } else {\n                            if (previousElements) {\n                                previousElements.remove();\n                                previousElements = null;\n                            }\n                            if (childScope) {\n                                childScope.$destroy();\n                                childScope = null;\n                            }\n                            if (block) {\n                                previousElements = getBlockElements(angular, block.clone);\n                                $animate.leave(previousElements, function () {\n                                    previousElements = null;\n                                });\n                                block = null;\n                            }\n                        }\n                    });\n                }\n            };\n        }).directive('serverIfPermission', ['$context','$compile', '$async', function($context, $compile, $async) {\n            return {\n                restrict:'E',\n                replace: true,\n                scope: { model:'@',mask:'@',state:'@' },\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element) {\n                            return $async(function(resolve, reject) {\n                                try {\n                                    const targetModel = $context.model(scope.model);\n                                    if (_.isNil(scope.state)) {\n                                        if (scope.mask)\n                                            if (scope.mask == 1)\n                                                scope.state = 0;\n                                            else if (scope.mask == 2)\n                                                scope.state = 1;\n                                            else if (scope.mask == 4)\n                                                scope.state = 2;\n                                            else if (scope.mask == 8)\n                                                scope.state = 4;\n                                            else\n                                                scope.state = scope.mask;\n                                    }\n                                    const p = new DataPermissionEventListener(),\n                                        e = { model: targetModel, state: scope.state, throwError:false };\n                                    p.validate(e, function(err) {\n                                        if (e.result) {\n                                            const result = $compile(element.contents())(scope);\n                                            element.replaceWith(result);\n                                            resolve();\n                                        }\n                                        else {\n                                            element.replaceWith(null);\n                                            resolve();\n                                        }\n                                    });\n                                }\n                                catch(err) {\n                                    reject(err.message);\n                                }\n                            });\n                        },\n                        post: angular.noop\n                    }\n                }\n            };\n        }]).directive('serverLoc', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLoc\n                     * @private\n                     */\n                    if (attrs.title)\n                        element.attr('title', $context.translate(attrs.title, attrs.serverLoc));\n                    if (attrs.placeholder)\n                        element.attr('placeholder', $context.translate(attrs.placeholder, attrs.serverLoc));\n                }\n            };\n        }]).directive('serverLocHtml', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLocHtml\n                     * @private\n                     */\n                    const text = $context.translate(element.html(), attrs.serverLocHtml);\n                    if (text)\n                        element.html(text);\n                }\n            };\n        }]).directive('serverUserInRole', ['$context', '$compile', function($context, $compile) {\n            return {\n                restrict:'A',\n                replace: true,\n                priority: 100,\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element, attrs) {\n                            const user = $context.user;\n                            if (typeof user !== 'undefined') {\n                                user.groups = user.groups || [];\n                                /**\n                                 * @ngdoc attrs\n                                 * @property {string} serverUserInRole\n                                 *\n                                 * @type {Array}\n                                 * @private\n                                 */\n                                const roles = (attrs.serverUserInRole || '').split(',');\n                                let inRole = (user.groups.filter(function(x) {\n                                    return (roles.indexOf(x.name)>=0);\n                                }).length>0);\n                                //validate not statement e.g. server-user-in-role='!Administrators'\n                                if (!inRole) {\n                                    roles.forEach(function(x) {\n                                        if (!inRole) {\n                                            if (x.indexOf('!')==0) {\n                                                inRole = (user.groups.filter(function(y) {\n                                                    return (x.substr(1).indexOf(y.name)>=0);\n                                                }).length==0);\n                                            }\n                                        }\n                                    });\n                                }\n                                if (!inRole) {\n                                    element.replaceWith(null);\n                                }\n                                else {\n                                    //do nothing (remove server attributes)\n                                    element.removeAttr('server-user-in-role').removeAttr('server:user-in-role');\n                                }\n                            }\n                        },\n                        post: angular.noop\n                    }\n                }\n            };\n        }]);\n    }\n}\n"]}