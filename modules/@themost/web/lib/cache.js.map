{"version":3,"sources":["cache.es6"],"names":["_","Rx","NodeCache","HttpApplicationService","AbstractClassError","AbstractMethodError","Args","TraceUtils","LangUtils","CacheStrategy","app","check","new","target","key","value","absoluteExpiration","fn","rawCacheProperty","Symbol","CACHE_ABSOLUTE_EXPIRATION","DefaultCacheStrategy","expiration","config","getConfiguration","settings","cache","parseInt","stdTTL","Observable","fromNodeCallback","set","flushAll","return","self","isFunction","get","flatMap","res","isNil","source","add"],"mappings":"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","file":"cache.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport {_} from 'lodash';\nimport Rx from 'rx';\nimport NodeCache from 'node-cache';\nimport {HttpApplicationService} from './interfaces';\nimport {AbstractClassError,AbstractMethodError} from '@themost/common/errors';\nimport {Args,TraceUtils,LangUtils} from '@themost/common/utils';\n\n/**\n * @classdesc Represents cache strategy for an HTTP application\n * @class\n * @abstract\n */\nexport class CacheStrategy extends HttpApplicationService {\n    /**\n     *\n     * @param {HttpApplication2} app\n     */\n    constructor(app) {\n        Args.check(new.target !== CacheStrategy, new AbstractClassError());\n        super(app);\n    }\n    /**\n     * Sets a key value pair in cache.\n     * @abstract\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    add(key, value, absoluteExpiration) {\n        throw new AbstractMethodError();\n    }\n\n    /**\n     * Removes a cached value.\n     * @abstract\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Observable}\n     */\n    remove(key) {\n        throw new AbstractMethodError();\n    }\n    /**\n     * Flush all cached data.\n     * @abstract\n     * @returns {Observable}\n     */\n    clear() {\n        throw new AbstractMethodError();\n    }\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string} key\n     * @returns {Observable}\n     */\n    get(key) {\n        throw new AbstractMethodError();\n    }\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        throw new AbstractMethodError();\n    }\n\n}\n\nconst rawCacheProperty = Symbol('rawCache');\nconst CACHE_ABSOLUTE_EXPIRATION = 0;\n\n/**\n * @classdesc Implements the cache for a data application.\n * @class\n */\nexport class DefaultCacheStrategy extends CacheStrategy  {\n    /**\n     *\n     * @constructor\n     * @param {HttpApplication2} app\n     */\n    constructor(app) {\n        super(app);\n        //set absoluteExpiration (from application configuration)\n        let expiration = CACHE_ABSOLUTE_EXPIRATION;\n        const config = app.getConfiguration();\n        if (config.settings && config.cache && config.cache['absoluteExpiration']) {\n            if (LangUtils.parseInt(config.cache['absoluteExpiration'])>=0) {\n                expiration = LangUtils.parseInt(config.cache['absoluteExpiration']);\n            }\n        }\n        this[rawCacheProperty] = new NodeCache( {\n            stdTTL:expiration\n        });\n\n    }\n\n    /**\n     * Removes a cached value.\n     * @abstract\n     * @param {string} key - A string that represents the key of the cached value to be removed\n     * @returns {Observable}\n     */\n    remove(key) {\n        return Rx.Observable.fromNodeCallback(this[rawCacheProperty].set, this[rawCacheProperty])(key);\n    }\n\n    /**\n    * Flush all cached data.\n     * @returns {Observable}\n    */\n    clear() {\n        this[rawCacheProperty].flushAll();\n        return Rx.Observable.return();\n    }\n\n    /**\n     * Sets a key value pair in cache.\n     * @param {string} key - A string that represents the key of the cached value\n     * @param {*} value - The value to be cached\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    add(key, value, absoluteExpiration) {\n\n        return Rx.Observable.fromNodeCallback(this[rawCacheProperty].set, this[rawCacheProperty])(key, value, absoluteExpiration);\n\n    }\n\n    /**\n     * Gets data from cache or executes the defined function and adds the result to the cache with the specified key\n     * @param {string|*} key - A string which represents the key of the cached data\n     * @param {Function} fn - A function to execute if data will not be found in cache\n     * @param {number=} absoluteExpiration - An absolute expiration time in seconds. This parameter is optional.\n     * @returns {Observable}\n     */\n    getOrDefault(key, fn, absoluteExpiration) {\n        const self = this;\n        Args.check(_.isFunction(fn),'Invalid argument. Expected function.');\n        return self.get(key).flatMap((res) => {\n           if (_.isNil(res)) {\n               let source = fn();\n               Args.check(source instanceof Observable, 'Invalid argument. Expected a valid observable.');\n               return source.flatMap((res) => {\n                   if (_.isNil(res)) {\n                       return Rx.Observable.return();\n                   }\n                   return self.add(key,res,absoluteExpiration).flatMap(() => {\n                       return Rx.Observable.return(res);\n                   });\n               });\n           }\n            return Rx.Observable.return(res);\n        });\n    }\n\n    /**\n     * Gets a cached value defined by the given key.\n     * @param {string|*} key\n     * @returns {Observable}\n     */\n    get(key) {\n        return Rx.Observable.fromNodeCallback(this[rawCacheProperty].get, this[rawCacheProperty])(key)\n            .flatMap((res) => {\n                return Rx.Observable.return(res[key]);\n            });\n\n    }\n}"]}