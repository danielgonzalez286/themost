{"version":3,"sources":["ejs.es6"],"names":["HttpViewContext","HttpNotFoundError","LangUtils","_","ejs","path","fs","EjsEngine","context","ctx","Object","defineProperty","get","set","value","configurable","enumerable","name","fn","filters","filename","data","callback","self","readFile","err","str","code","matcher","properties","layout","test","matches","exec","JSON","parse","replace","viewContext","assign","partial","request","route","parseBoolean","application","mapPath","resolve","body","render","layoutData","result","e","call"],"mappings":"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","file":"ejs.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\nimport {HttpViewContext} from './../mvc';\nimport {HttpNotFoundError} from '@themost/common/errors';\nimport {LangUtils} from '@themost/common/utils';\nimport {_} from 'lodash';\nimport ejs from 'ejs';\nimport path from 'path';\nimport fs from 'fs';\n\n\n/**\n * @class\n * @param {HttpContext=} context\n * @constructor\n * @property {HttpContext} context Gets or sets an instance of HttpContext that represents the current HTTP context.\n */\nexport default class EjsEngine {\n    /**\n     *\n     * @param {HttpContext} context\n     */\n    constructor(context) {\n        /**\n         * @type {HttpContext}\n         */\n        let ctx = context;\n        Object.defineProperty(this,'context', {\n            get: function() {\n                return ctx;\n            },\n            set: function(value) {\n                ctx = value;\n            },\n            configurable:false,\n            enumerable:false\n        });\n\n    }\n\n    /**\n     * Adds a EJS filter to filters collection.\n     * @param {string} name\n     * @param {Function} fn\n     */\n    filter(name, fn) {\n        ejs.filters[name] = fn;\n    }\n\n    /**\n     *\n     * @param {string} filename\n     * @param {*=} data\n     * @param {Function} callback\n     */\n    render(filename, data, callback) {\n        const self = this;\n        try {\n            fs.readFile(filename,'utf-8', function(err, str) {\n                try {\n                    if (err) {\n                        if (err.code === 'ENOENT') {\n                            //throw not found exception\n                            return callback(new HttpNotFoundError('View layout cannot be found.'));\n                        }\n                        return callback(err);\n                    }\n                    else {\n                        //get view header (if any)\n                        const matcher = /^(\\s*)<%#(.*?)%>/;\n                        let properties = { layout:null };\n                        if (matcher.test(str)) {\n                            const matches = matcher.exec(str);\n                            properties = JSON.parse(matches[2]);\n                            //remove match\n                            str = str.replace(matcher,'');\n                        }\n                        //create view context\n                        const viewContext = new HttpViewContext(self.context);\n                        //extend view context with page properties\n                        _.assign(viewContext, properties || {});\n                        //set view context data\n                        viewContext.data = data;\n                        let partial = false;\n                        if (self.context && self.context.request.route)\n                            partial = LangUtils.parseBoolean(self.context.request.route['partial']);\n                        if (properties.layout && !partial) {\n                            let layout;\n                            if (/^\\//.test(properties.layout)) {\n                                //relative to application folder e.g. /views/shared/master.html.ejs\n                                layout = self.context.application.mapPath(properties.layout);\n                            }\n                            else {\n                                //relative to view file path e.g. ./../master.html.html.ejs\n                                layout = path.resolve(filename, properties.layout);\n                            }\n                            //set current view buffer (after rendering)\n                            viewContext.body = ejs.render(str, viewContext);\n                            //render master layout\n                            fs.readFile(layout,'utf-8', function(err, layoutData) {\n                                try {\n                                    if (err) {\n                                        if (err.code === 'ENOENT') {\n                                            return callback(new HttpNotFoundError('Master view layout cannot be found'));\n                                        }\n                                        return callback(err);\n                                    }\n                                    const result = ejs.render(layoutData, viewContext);\n                                    callback(null, result);\n                                }\n                                catch (e) {\n                                    callback(e);\n                                }\n                            });\n                        }\n                        else {\n                            const result = ejs.render(str, viewContext);\n                            callback(null, result);\n                        }\n                    }\n                }\n                catch (e) {\n                    callback(e);\n                }\n            });\n\n        }\n        catch (e) {\n            callback.call(self, e);\n        }\n    }\n}\n"]}