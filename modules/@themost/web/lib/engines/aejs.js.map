{"version":3,"sources":["aejs.es6"],"names":["HttpViewContext","HttpNotFoundError","LangUtils","_","aejs","path","step_","funcs","onerror","counter","completed","pointer","ended","state","values","complete","check","next","err","value","noop","apply","fn","args","length","key","index","Error","step","render_","src","options","callback","fns","file","filename","renderFile","proto","Object","getPrototypeOf","keys","i","forEach","name","push","concat","Array","prototype","slice","call","arguments","result","ejs","render","arg","shift","parallel","results","AsyncEjsEngine","context","ctx","defineProperty","get","set","configurable","enumerable","filters","data","self","fs","require","common","readFile","str","code","matcher","properties","layout","test","matches","exec","JSON","parse","replace","viewContext","util","_extend","partial","request","route","parseBoolean","application","mapPath","resolve","body","layoutData","e"],"mappings":"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","file":"aejs.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n'use strict';\n'use strict';\nimport {HttpViewContext} from './../mvc';\nimport {HttpNotFoundError} from '@themost/common/errors';\nimport {LangUtils} from '@themost/common/utils';\nimport {_} from 'lodash';\nimport aejs from 'async-ejs';\nimport path from 'path';\n\n\n\nconst step_ = function(funcs, onerror) {\n    let counter = 0;\n    let completed = 0;\n    let pointer = 0;\n    let ended = false;\n    const state = {};\n    let values = null;\n    let complete = false;\n\n    const check = function() {\n        return complete && completed >= counter;\n    };\n\n    class next {\n        constructor(err, value) {\n            if (err && !ended) {\n                ended = true;\n                (onerror || noop).apply(state, [err]);\n                return;\n            }\n            if (ended || (counter && !check())) {\n                return;\n            }\n\n            const fn = funcs[pointer++];\n            const args = (fn.length === 1 ? [next] : [value, next]);\n\n            counter = completed = 0;\n            values = [];\n            complete = false;\n            fn.apply(state, pointer < funcs.length ? args : [value, next]);\n            complete = true;\n\n            if (counter && check()) {\n                next(null, values);\n            }\n        }\n\n        static parallel(key) {\n            const index = counter++;\n\n            if (complete) {\n                throw new Error('next.parallel must not be called async');\n            }\n            return function(err, value) {\n                completed++;\n                values[key ? key : index] = value;\n                next(err, values);\n            };\n        }\n\n        static skip(step) {\n            pointer += step;\n            return function (err, value) {\n                next(err, value);\n            }\n        }\n    }\n\n    next();\n};\n\n/**\n * @param {string} src\n * @param {*} options\n * @param {Function} callback\n * @private\n */\nconst render_ = function(src, options, callback) {\n    if (!callback) {\n        callback = options;\n        options = {};\n    }\n    const fns = {\n        file: function(filename, callback) {\n            aejs.renderFile(filename, options, callback);\n        }\n    };\n    //get prototype of options.local\n    const proto = Object.getPrototypeOf(options);\n    if (proto) {\n        const keys = Object.keys(proto);\n        for (let i = 0; i < keys.length; i++) {\n            const key = keys[i];\n            if (typeof proto[key] === 'function')\n                fns[key] = proto[key];\n        }\n    }\n    step_([\n        function(next) {\n            const args = [];\n            Object.keys(fns).forEach(function(name) {\n                options[name] = function() {\n                    args.push([name].concat(Array.prototype.slice.call(arguments)));\n                };\n            });\n            const result = ejs.render(src, options);\n            if (!args.length) {\n                callback(null, result);\n                return;\n            }\n            args.forEach(function(arg) {\n                const name = arg.shift();\n                arg.push(next.parallel());\n                fns[name].apply(options, arg);\n            });\n        },\n        function(results, next) {\n            let i = 0;\n            Object.keys(fns).forEach(function(name) {\n                options[name] = function() {\n                    return results[i++];\n                }\n            });\n            src = ejs.render(src, options);\n            callback(null,src);\n        }\n    ], callback);\n};\n//override render method of async-ejs\naejs.render = render_;\n\n/**\n * @class\n */\nexport default class AsyncEjsEngine {\n    /**\n     * @constructor\n     * @param {HttpContext} context\n     */\n    constructor(context) {\n        /**\n         * @type {HttpContext}\n         */\n        let ctx = context;\n        Object.defineProperty(this,'context', {\n            get: function() {\n                return ctx;\n            },\n            set: function(value) {\n                ctx = value;\n            },\n            configurable:false,\n            enumerable:false\n        });\n    }\n\n    /**\n     * Adds a EJS filter to filters collection.\n     * @param {string} name\n     * @param {Function} fn\n     */\n    filter(name, fn) {\n        ejs.filters[name] = fn;\n    }\n\n    render(filename, data, callback) {\n        const self = this;\n        try {\n            const fs = require('fs'), common = require('@themost/common');\n            fs.readFile(filename,'utf-8', function(err, str) {\n                try {\n                    if (err) {\n                        if (err.code === 'ENOENT') {\n                            //throw not found exception\n                            return callback(new HttpNotFoundError('View layout cannot be found.'));\n                        }\n                        return callback(err);\n                    }\n                    else {\n                        //get view header (if any)\n                        const matcher = /^(\\s*)<%#(.*?)%>/;\n                        let properties = { layout:null };\n                        if (matcher.test(str)) {\n                            const matches = matcher.exec(str);\n                            properties = JSON.parse(matches[2]);\n                            //remove match\n                            str = str.replace(matcher,'');\n                        }\n                        //create view context\n                        const viewContext = new HttpViewContext(self.context);\n                        //extend view context with page properties\n                        util._extend(viewContext, properties || {});\n                        //set view context data\n                        viewContext.data = data;\n                        let partial = false;\n                        if (self.context && self.context.request.route)\n                            partial = LangUtils.parseBoolean(self.context.request.route['partial']);\n                        if (properties.layout && !partial) {\n                            let layout;\n                            if (/^\\//.test(properties.layout)) {\n                                //relative to application folder e.g. /views/shared/master.html.ejs\n                                layout = self.context.application.mapPath(properties.layout);\n                            }\n                            else {\n                                //relative to view file path e.g. ./../master.html.html.ejs\n                                layout = path.resolve(filename, properties.layout);\n                            }\n                            //set current view buffer (after rendering)\n                            aejs.render(str, viewContext, function (err, body) {\n                                if (err) {\n                                    return callback(err);\n                                }\n                                viewContext.body = body;\n                                fs.readFile(layout,'utf-8', function(err, layoutData) {\n                                    try {\n                                        if (err) {\n                                            if (err.code === 'ENOENT') {\n                                                return callback(new HttpNotFoundError('Master view layout cannot be found'));\n                                            }\n                                            return callback(err);\n                                        }\n                                        aejs.render(layoutData, viewContext , function (err, result) {\n                                            return callback(null, result);\n                                        });\n                                    }\n                                    catch (e) {\n                                        callback(e);\n                                    }\n                                });\n                            });\n                            \n                        }\n                        else {\n                            aejs.render(str, viewContext , function (err, result) {\n                                return callback(null, result);\n                            });\n                        }\n                    }\n                }\n                catch (e) {\n                    callback(e);\n                }\n            });\n\n        }\n        catch (e) {\n            callback.call(self, e);\n        }\n    }\n}\n"]}