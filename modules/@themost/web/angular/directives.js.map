{"version":3,"sources":["angular/directives.es6"],"names":["_","DataPermissionEventListener","toBoolean","value","length","v","lowerCase","getBlockElements","angular","nodes","startNode","endNode","element","elements","nextSibling","push","AngularServerModuleDefaults","module","directive","$context","$async","$parse","replace","restrict","link","scope","attrs","resolve","reject","src","serverInclude","getApplication","executeRequest","url","cookie","request","headers","then","result","removeAttr","replaceWith","body","catch","err","message","priority","$eval","serverInit","$animate","$document","transclude","terminal","$$tlb","$scope","$element","$attr","ctrl","$transclude","block","childScope","previousElements","serverIf","parentDocument","get","$watch","ngIfWatchAction","$new","clone","createComment","enter","parent","remove","$destroy","leave","$compile","model","mask","state","compile","pre","preLink","targetModel","isNil","p","event","throwError","validate","contents","post","noop","title","attr","translate","serverLoc","placeholder","text","html","serverLocHtml","user","groups","roles","serverUserInRole","split","inRole","find","x","indexOf","name","forEach","y","substr"],"mappings":"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","file":"directives.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport 'source-map-support/register';\nimport {_} from 'lodash';\nimport {DataPermissionEventListener} from '@themost/data/permission';\n\nfunction toBoolean(value) {\n    if (typeof value === 'function') {\n        value = true;\n    } else if (value && value.length !== 0) {\n        const v = _.lowerCase(\"\" + value);\n        value = !(v === 'f' || v === '0' || v === 'false' || v === 'no' || v === 'n' || v === '[]');\n    } else {\n        value = false;\n    }\n    return value;\n}\nfunction getBlockElements(angular, nodes) {\n    const startNode = nodes[0], endNode = nodes[nodes.length - 1];\n    if (startNode === endNode) {\n        return angular.element(startNode);\n    }\n\n    let element = startNode;\n    const elements = [element];\n\n    do {\n        element = element.nextSibling;\n        if (!element) break;\n        elements.push(element);\n    } while (element !== endNode);\n\n    return angular.element(elements);\n}\n\nexport class AngularServerModuleDefaults {\n    /**\n     * @param {AngularServerModule} module\n     */\n    static applyDirectives(module) {\n        module.directive('serverInclude', function($context, $async, $parse) {\n            return {\n                replace:true,\n                restrict:'EA',\n                link: function (scope, element, attrs) {\n                    return $async(function(resolve, reject) {\n                        //get angular instance\n                        const angular = this.angular;\n                        /**\n                         * @ngdoc attrs\n                         * @property {string} serverInclude\n                         * @property {string} src\n                         */\n                        const src = $parse(attrs.serverInclude)(scope);\n                        if (src) {\n                            $context.getApplication().executeRequest({\n                                url: src,\n                                cookie: $context.request.headers.cookie\n                            }).then((result)=>{\n                                element.removeAttr('data-src');\n                                element.replaceWith(angular.element(result.body.replace(/\\n/,'')));\n                                resolve();\n                            }).catch((err) => {\n                                element.replaceWith(null);\n                                reject(err.message);\n                            });\n                        }\n                    });\n                }\n            };\n        }).directive('serverInit', function() {\n            return {\n                priority:400,\n                restrict:'A',\n                link: function (scope, element, attrs) {\n                    /**\n                     * @ngdoc attrs\n                     * @property {string} serverInit\n                     */\n                    scope.$eval(attrs.serverInit);\n                }\n            };\n        }).directive('serverIf', function($animate, $document) {\n            return {\n                transclude: 'element',\n                priority: 600,\n                terminal: true,\n                restrict: 'A',\n                $$tlb: true,\n                link: function ($scope, $element, $attr, ctrl, $transclude) {\n                    let block, childScope, previousElements;\n                    const serverIf = $attr['serverIf'], parentDocument = $document.get(0);\n                    $scope.$watch(serverIf, function ngIfWatchAction(value) {\n                        if (toBoolean(value)) {\n                            if (!childScope) {\n                                childScope = $scope.$new(false);\n                                $transclude(childScope, function (clone) {\n                                    clone.push(parentDocument.createComment(''));\n                                    //clone[clone.length++] = parentDocument.createComment('');\n                                    block = {\n                                        clone: clone\n                                    };\n                                    $animate.enter(clone, $element.parent(), $element);\n                                });\n                            }\n                        } else {\n                            if (previousElements) {\n                                previousElements.remove();\n                                previousElements = null;\n                            }\n                            if (childScope) {\n                                childScope.$destroy();\n                                childScope = null;\n                            }\n                            if (block) {\n                                previousElements = getBlockElements(angular, block.clone);\n                                $animate.leave(previousElements, function () {\n                                    previousElements = null;\n                                });\n                                block = null;\n                            }\n                        }\n                    });\n                }\n            };\n        }).directive('serverIfPermission', ['$context','$compile', '$async', function($context, $compile, $async) {\n            return {\n                restrict:'E',\n                replace: true,\n                scope: { model:'@',mask:'@',state:'@' },\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element) {\n                            return $async(function(resolve, reject) {\n                                try {\n                                    const targetModel = $context.model(scope.model);\n                                    if (_.isNil(scope.state)) {\n                                        if (scope.mask)\n                                            if (scope.mask === 1)\n                                                scope.state = 0;\n                                            else if (scope.mask === 2)\n                                                scope.state = 1;\n                                            else if (scope.mask === 4)\n                                                scope.state = 2;\n                                            else if (scope.mask === 8)\n                                                scope.state = 4;\n                                            else\n                                                scope.state = scope.mask;\n                                    }\n                                    const p = new DataPermissionEventListener(),\n                                        event = { model: targetModel, state: scope.state, throwError:false };\n                                    p.validate(event, function(err) {\n                                        if (event.result) {\n                                            const result = $compile(element.contents())(scope);\n                                            element.replaceWith(result);\n                                            resolve();\n                                        }\n                                        else {\n                                            element.replaceWith(null);\n                                            resolve();\n                                        }\n                                    });\n                                }\n                                catch(err) {\n                                    reject(err.message);\n                                }\n                            });\n                        },\n                        post: angular.noop\n                    };\n                }\n            };\n        }]).directive('serverLoc', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLoc\n                     * @private\n                     */\n                    if (attrs.title)\n                        element.attr('title', $context.translate(attrs.title, attrs.serverLoc));\n                    if (attrs.placeholder)\n                        element.attr('placeholder', $context.translate(attrs.placeholder, attrs.serverLoc));\n                }\n            };\n        }]).directive('serverLocHtml', ['$context', function($context) {\n            return {\n                restrict: 'A',\n                link: function(scope, element, attrs) {\n                    /**\n                     * @ngdoc\n                     * @name attrs\n                     * @property {string} serverLocHtml\n                     * @private\n                     */\n                    const text = $context.translate(element.html(), attrs.serverLocHtml);\n                    if (text)\n                        element.html(text);\n                }\n            };\n        }]).directive('serverUserInRole', ['$context', '$compile', function($context) {\n            return {\n                restrict:'A',\n                replace: true,\n                priority: 100,\n                compile:function() {\n                    return {\n                        pre: function preLink(scope, element, attrs) {\n                            const user = $context.user;\n                            if (typeof user !== 'undefined') {\n                                user.groups = user.groups || [];\n                                /**\n                                 * @ngdoc attrs\n                                 * @property {string} serverUserInRole\n                                 *\n                                 * @type {Array}\n                                 * @private\n                                 */\n                                const roles = (attrs.serverUserInRole || '').split(',');\n                                let inRole = (typeof _.find(user.groups, (x) => {\n                                    return (roles.indexOf(x.name)>=0);\n                                }) !== 'undefined');\n                                //validate not statement e.g. server-user-in-role='!Administrators'\n                                if (!inRole) {\n                                    _.forEach(roles, function(x) {\n                                        if (!inRole) {\n                                            if (x.indexOf('!')===0) {\n                                                inRole = (typeof _.find(user.groups, function(y) {\n                                                    return (x.substr(1).indexOf(y.name)>=0);\n                                                }) !== 'undefined');\n                                            }\n                                        }\n                                    });\n                                }\n                                if (!inRole) {\n                                    element.replaceWith(null);\n                                }\n                                else {\n                                    //do nothing (remove server attributes)\n                                    element.removeAttr('server-user-in-role').removeAttr('server:user-in-role');\n                                }\n                            }\n                        },\n                        post: angular.noop\n                    };\n                }\n            };\n        }]);\n    }\n}\n"]}