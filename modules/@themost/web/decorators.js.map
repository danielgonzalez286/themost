{"version":3,"sources":["decorators.es6"],"names":["httpGet","httpPost","httpPut","httpDelete","httpAction","httpParam","httpAuthorize","_","Q","HttpBadRequestError","HttpUnauthorizedError","HttpConsumer","TraceUtils","LangUtils","Args","DataTypeValidator","MinValueValidator","MaxValueValidator","MaxLengthValidator","MinLengthValidator","PatternValidator","RequiredValidator","DecoratorError","Error","target","key","descriptor","value","name","TypeError","HttpParamAttributeOptions","options","httpParams","extend","context","httpParamValidationFailedCallback","validationResult","log","assign","request","url","method","reject","message","methodParams","getFunctionParams","length","k","validator","functionParam","contextParam","getParam","params","isObject","type","setContext","validateSync","pattern","RegExp","minLength","maxLength","minValue","maxValue","required","check","authorize","user"],"mappings":"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","file":"decorators.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\n\nimport 'source-map-support/register';\nimport _ from 'lodash';\nimport Q from 'q';\nimport {HttpBadRequestError} from '@themost/common/errors';\nimport {HttpConsumer} from './consumers';\nimport {HttpUnauthorizedError} from \"@themost/common/errors\";\nimport {TraceUtils} from \"@themost/common/utils\";\nimport {LangUtils} from \"@themost/common/utils\";\nimport {DataTypeValidator,MinValueValidator, MaxValueValidator,MaxLengthValidator,MinLengthValidator,PatternValidator,RequiredValidator} from '@themost/data/validators';\nimport {Args} from \"@themost/common/utils\";\n\n/**\n * @class\n * @extends Error\n */\nexport class DecoratorError extends Error {\n    constructor() {\n        super('Decorator is not valid on this declaration type.');\n    }\n}\n\nexport function httpGet() {\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value === 'function') {\n            descriptor.value.httpGet = true;\n        }\n        return descriptor;\n    }\n}\n\nexport function httpPost() {\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value !== 'function') {\n            throw new DecoratorError();\n        }\n        descriptor.value.httpPost = true;\n        return descriptor;\n    }\n}\n\nexport function httpPut() {\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value !== 'function') {\n            throw new DecoratorError();\n        }\n        descriptor.value.httpPut = true;\n        return descriptor;\n    }\n}\n\nexport function httpDelete() {\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value !== 'function') {\n            throw new DecoratorError();\n        }\n        descriptor.value.httpDelete = true;\n        return descriptor;\n    }\n}\n/**\n *\n * @param {string} name\n * @returns {Function}\n */\nexport function httpAction(name) {\n    if (typeof name !== 'string') {\n        throw new TypeError('Action name must be a string');\n    }\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value !== 'function') {\n            throw new DecoratorError();\n        }\n        descriptor.value.httpAction = name;\n        return descriptor;\n    }\n}\n\n/**\n* @class\n* @abstract\n* @property {string} name\n* @property {string} type\n* @property {RegExp|string} pattern\n* @property {date|number|*} minValue\n* @property {date|number|*} maxValue\n* @property {number} minLength\n* @property {number} maxLength\n* @property {boolean} required\n* @property {string} message\n* @constructor\n*/\nfunction HttpParamAttributeOptions() {\n    //\n}\n\n/**\n * @param {*=} options\n * @returns {Function}\n */\nexport function httpParam(options) {\n    if (typeof options !== 'object') { throw new TypeError('Parameter options must be an object'); }\n    if (typeof options.name !== 'string') { throw new TypeError('Parameter name must be a string'); }\n    return function (target, key, descriptor) {\n        if (typeof descriptor.value !== 'function') {\n            throw new Error('Decorator is not valid on this declaration type.');\n        }\n\n        descriptor.value.httpParams = descriptor.value.httpParams || { };\n        descriptor.value.httpParams[options.name] = _.extend({\"type\":\"Text\"}, options);\n        if (typeof descriptor.value.httpParam === 'undefined') {\n            descriptor.value.httpParam = new HttpConsumer((context)=> {\n                const httpParamValidationFailedCallback = function httpParamValidationFailedCallback(context, httpParam, validationResult) {\n                    TraceUtils.log(_.assign(validationResult, {\n                        \"param\":httpParam,\n                        \"request\": {\n                            \"url\":context.request.url,\n                            \"method\":context.request.method\n                        }\n                    }));\n                    return Q.reject(new HttpBadRequestError('Bad request parameter', httpParam.message || validationResult.message));\n                };\n                const methodParams = LangUtils.getFunctionParams(descriptor.value);\n                const httpParams = descriptor.value.httpParams;\n                if (methodParams.length>0) {\n                    let k = 0, httpParam, validator, validationResult, functionParam, contextParam;\n                    while (k < methodParams.length) {\n                        functionParam = methodParams[k];\n                        if (typeof context.getParam === 'function') {\n                            contextParam = context.getParam(functionParam);\n                        }\n                        else {\n                            contextParam = context.params[functionParam];\n                        }\n                        if (_.isObject(httpParams)) {\n                            httpParam = httpParams[functionParam];\n                            if (_.isObject(httpParam)) {\n                                if (typeof httpParam.type === 'string') {\n                                    //--validate type\n                                    validator = new DataTypeValidator(httpParam.type);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                                if (httpParam.pattern instanceof RegExp) {\n                                    //--validate pattern\n                                    validator = new PatternValidator(httpParam.pattern);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                                if (typeof httpParam.minLength === 'number') {\n                                    //--validate min length\n                                    validator = new MinLengthValidator(httpParam.minLength);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                                if (typeof httpParam.maxLength === 'number') {\n                                    //--validate max length\n                                    validator = new MaxLengthValidator(httpParam.maxLength);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                                if (typeof httpParam.minValue !== 'undefined') {\n                                    //--validate min value\n                                    validator = new MinValueValidator(httpParam.minValue);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                                if (typeof httpParam.maxValue !== 'undefined') {\n                                    //--validate max value\n                                    validator = new MaxValueValidator(httpParam.required);\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n\n                                if ((typeof httpParam.required !== 'undefined') && (httpParam.required === true)) {\n                                    //--validate required value\n                                    validator = new RequiredValidator();\n                                    validator.setContext(context);\n                                    validationResult = validator.validateSync(contextParam);\n                                    if (validationResult) {\n                                        return httpParamValidationFailedCallback(context, httpParam, validationResult);\n                                    }\n                                }\n                            }\n                        }\n                        k += 1;\n                    }\n                }\n                return Q();\n            });\n        }\n        return descriptor;\n    }\n}\n/**\n *\n * @param {boolean=} value\n * @returns {Function}\n */\nexport function httpAuthorize(value) {\n    return function (target, key, descriptor) {\n        Args.check(typeof descriptor.value === 'function', new DecoratorError());\n        let authorize = true;\n        if (typeof value === 'boolean') {\n            authorize = value;\n        }\n        if (authorize) {\n            descriptor.value.authorize = new HttpConsumer((context) => {\n                if (context.user && context.user.name !== 'anonymous') {\n                    return Q();\n                }\n                return Q.reject(new HttpUnauthorizedError());\n            });\n        }\n        return descriptor;\n    }\n}"]}